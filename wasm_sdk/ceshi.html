<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>加密传输测试</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans SC', Inter, sans-serif; background: #F8FAFC; color: #1E293B; padding: 24px; line-height: 1.6; }
        h1 { font-size: 20px; margin-bottom: 20px; color: #0F172A; }
        .card { background: rgba(255,255,255,0.9); border: 1px solid #E2E8F0; border-radius: 12px; padding: 20px; margin-bottom: 16px; }
        .card h2 { font-size: 15px; color: #475569; margin-bottom: 12px; }
        button { background: #3B82F6; color: #fff; border: none; border-radius: 8px; padding: 10px 20px; font-size: 14px; cursor: pointer; transition: background-color 200ms; min-height: 44px; margin-right: 8px; margin-bottom: 8px; }
        button:hover { background: #2563EB; }
        button:focus { outline: none; box-shadow: 0 0 0 2px #3B82F6; }
        button:disabled { background: #94A3B8; cursor: not-allowed; }
        .log { background: #0F172A; color: #E2E8F0; border-radius: 8px; padding: 16px; font-family: 'JetBrains Mono', monospace; font-size: 13px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; margin-top: 12px; }
        .ok { color: #10B981; }
        .err { color: #EF4444; }
        .info { color: #3B82F6; }
        .warn { color: #F59E0B; }
        .zhuangtai { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; vertical-align: middle; }
        .zhuangtai.lianjiecheng { background: #D1FAE5; color: #065F46; }
        .zhuangtai.weilianjiecheng { background: #FEE2E2; color: #991B1B; }
        input { border: 1px solid #E2E8F0; border-radius: 8px; padding: 10px 14px; font-size: 14px; min-height: 44px; outline: none; transition: border-color 200ms; color: #1E293B; background: #fff; }
        input:focus { border-color: #3B82F6; box-shadow: 0 0 0 2px rgba(59,130,246,0.2); }
        label { font-size: 13px; color: #475569; margin-bottom: 4px; display: block; }
        .shurukuang { display: flex; gap: 8px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 8px; }
        .shuruxiang { display: flex; flex-direction: column; }
        .shuruxiang button { margin: 0; }
        .aq-biao { width: 100%; border-collapse: collapse; font-size: 13px; }
        .aq-biao th { background: #F1F5F9; color: #475569; padding: 8px 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #E2E8F0; }
        .aq-biao td { padding: 8px 10px; border-bottom: 1px solid #E2E8F0; }
        .aq-biao tr:hover { background: #F8FAFC; }
        .aq-btn { background: #3B82F6; color: #fff; border: none; border-radius: 6px; padding: 6px 14px; font-size: 13px; cursor: pointer; transition: background-color 200ms; min-height: 36px; }
        .aq-btn:hover { background: #2563EB; }
        .aq-btn:focus { outline: none; box-shadow: 0 0 0 2px #3B82F6; }
        .aq-btn-zhu { background: #3B82F6; }
        .aq-btn-lv { background: #10B981; }
        .aq-btn-lv:hover { background: #059669; }
        .aq-btn-huang { background: #F59E0B; }
        .aq-btn-huang:hover { background: #D97706; }
        .aq-btn-hong { background: #EF4444; }
        .aq-btn-hong:hover { background: #DC2626; }
        .aq-btn-xiao { padding: 4px 10px; font-size: 12px; min-height: 30px; margin-right: 4px; }
        .aq-biaodan { max-width: 500px; }
        .aq-hang { display: flex; flex-direction: column; margin-bottom: 10px; }
        .aq-hang label { font-size: 13px; color: #475569; margin-bottom: 4px; }
        .aq-hang input { border: 1px solid #E2E8F0; border-radius: 8px; padding: 8px 12px; font-size: 14px; outline: none; transition: border-color 200ms; color: #1E293B; background: #fff; }
        .aq-hang input:focus { border-color: #3B82F6; box-shadow: 0 0 0 2px rgba(59,130,246,0.2); }
        .aq-hang input:disabled { background: #F1F5F9; color: #94A3B8; }
        .aq-hang select { border: 1px solid #E2E8F0; border-radius: 8px; padding: 8px 12px; font-size: 14px; outline: none; transition: border-color 200ms; color: #1E293B; background: #fff; cursor: pointer; }
        .aq-hang select:focus { border-color: #3B82F6; box-shadow: 0 0 0 2px rgba(59,130,246,0.2); }
    </style>
</head>
<body>
    <h1>AI日报系统-SDK</h1>

    <div class="card">
        <h2>SDK连接状态</h2>
        <p>SDK: <span id="wasm_zhuangtai" class="zhuangtai weilianjiecheng">加载中...</span></p>
    </div>

    <div class="card">
        <h2>请求测试</h2>
        <button id="btn_jiankang" onclick="jiankangqingqiu()" disabled>普通健康检查</button>
        <button id="btn_jiamiqingqiu" onclick="jiamijiankangqingqiu()" disabled>加密健康测试</button>
        <button id="btn_sseceshi" onclick="sseceshiqingqiu()" disabled>普通SSE测试</button>
        <button id="btn_jiamisseceshi" onclick="jiamisseceshiqingqiu()" disabled>加密SSE测试</button>
        <button id="btn_chongzhi" onclick="chongzhihuihua()" disabled>重置会话</button>
    </div>

    <div class="card">
        <h2>登录测试</h2>
        <div class="shurukuang">
            <div class="shuruxiang">
                <label for="denglu_zhanghao">账号</label>
                <input id="denglu_zhanghao" type="text" value="xiaoluo" placeholder="请输入账号">
            </div>
            <div class="shuruxiang">
                <label for="denglu_mima">密码</label>
                <input id="denglu_mima" type="password" value="5201314" placeholder="请输入密码">
            </div>
            <div class="shuruxiang">
                <label style="visibility:hidden">占位</label>
                <button id="btn_denglu" onclick="dengluqingqiu()" disabled>加密登录</button>
            </div>
        </div>
    </div>

    <div class="card">
        <h2>日志</h2>
        <button onclick="qingkongrizhi()" style="background:#64748B;font-size:12px;padding:6px 14px;min-height:36px;cursor:pointer;color:#fff;border:none;border-radius:8px">清空</button>
        <div id="rizhi" class="log"></div>
    </div>

    <div class="card" id="aiqudao_mianban"></div>

    <div class="card" id="aiduihua_mianban"></div>

    <script type="module">
        const v = Date.now();
        import(`./pkg/wasm_sdk.js?v=${v}`).then(module => {
            return Promise.all([
                module,
                import(`./aiqudao_luoji.js?v=${v}`),
                import(`./aiqudao_jiemian.js?v=${v}`),
                import(`./aiduihua_luoji.js?v=${v}`),
                import(`./aiduihua_jiemian.js?v=${v}`)
            ]);
        }).then(([wasm, aiqudaoluoji, aiqudaojiemian, aiduihualuoji, aiduihuajiemian]) => {
            const { default: init, Kehuduanjiami } = wasm;
            const { Aiqudaoluoji } = aiqudaoluoji;
            const { Aiqudaojiemian } = aiqudaojiemian;
            const { Aiduihualuoji } = aiduihualuoji;
            const { Aiduihuajiemian } = aiduihuajiemian;

        const fuwuqidizhi = 'http://127.0.0.1:8889';
        let kehu = null;
        let aiqudao_jm = null;
        let aiduihua_jm = null;

        function rizhi(neirong, leixing = '') {
            const el = document.getElementById('rizhi');
            const shijian = new Date().toLocaleTimeString();
            const leixingclass = leixing ? ` class="${leixing}"` : '';
            el.innerHTML += `<span style="color:#64748B">[${shijian}]</span> <span${leixingclass}>${neirong}</span>\n`;
            el.scrollTop = el.scrollHeight;
        }

        function gengxinzhuangtai(id, wenben, chenggong) {
            const el = document.getElementById(id);
            el.textContent = wenben;
            el.className = 'zhuangtai ' + (chenggong ? 'lianjiecheng' : 'weilianjiecheng');
        }

        async function zidongchushihua() {
            try {
                await init();
                kehu = new Kehuduanjiami(fuwuqidizhi);
                gengxinzhuangtai('wasm_zhuangtai', '已就绪', true);
                rizhi('WASM 自动加载成功，服务器: ' + fuwuqidizhi, 'ok');
                if (kehu.yidenglu()) {
                    rizhi('检测到已保存的登录令牌，自动恢复登录状态', 'info');
                }
                document.getElementById('btn_jiankang').disabled = false;
                document.getElementById('btn_jiamiqingqiu').disabled = false;
                document.getElementById('btn_sseceshi').disabled = false;
                document.getElementById('btn_jiamisseceshi').disabled = false;
                document.getElementById('btn_chongzhi').disabled = false;
                document.getElementById('btn_denglu').disabled = false;
                const aiqudao_lj = new Aiqudaoluoji(kehu, rizhi);
                aiqudao_jm = new Aiqudaojiemian(aiqudao_lj, 'aiqudao_mianban');
                aiqudao_jm.xuanran();
                const aiduihua_lj = new Aiduihualuoji(kehu, rizhi);
                aiduihua_jm = new Aiduihuajiemian(aiduihua_lj, 'aiduihua_mianban');
                aiduihua_jm.xuanran();
            } catch (e) {
                gengxinzhuangtai('wasm_zhuangtai', '加载失败', false);
                rizhi('WASM 加载失败: ' + e, 'err');
            }
        }

        zidongchushihua();

        async function zhixinganniu(anniuid, caozuo) {
            if (!kehu) return rizhi('尚未初始化', 'warn');
            const btn = document.getElementById(anniuid);
            btn.disabled = true;
            try {
                await caozuo();
            } catch (e) {
                rizhi('请求失败: ' + e, 'err');
            } finally {
                btn.disabled = false;
            }
        }

        window.chongzhihuihua = function() {
            if (!kehu) return;
            kehu.chongzhihuihua();
            rizhi('会话已重置，下次加密请求将自动重新协商', 'warn');
        };

        window.jiankangqingqiu = () => zhixinganniu('btn_jiankang', async () => {
            const jieguo = await kehu.jiankangqingqiu();
            rizhi('健康检查: ' + jieguo, 'ok');
        });

        window.jiamijiankangqingqiu = () => zhixinganniu('btn_jiamiqingqiu', async () => {
            const jieguo = await kehu.jiamijiankangqingqiu("你好加密传输");
            rizhi('加密响应: ' + jieguo, 'ok');
        });

        window.sseceshiqingqiu = () => zhixinganniu('btn_sseceshi', async () => {
            rizhi('--- 普通SSE开始 ---', 'info');
            await kehu.sseceshiqingqiu('sse_huidiao');
            rizhi('--- 普通SSE结束 ---', 'info');
        });

        window.jiamisseceshiqingqiu = () => zhixinganniu('btn_jiamisseceshi', async () => {
            rizhi('--- 加密SSE开始 ---', 'info');
            await kehu.jiamisseceshiqingqiu('sse_huidiao');
            rizhi('--- 加密SSE结束 ---', 'info');
        });

        window.dengluqingqiu = () => zhixinganniu('btn_denglu', async () => {
            const zhanghao = document.getElementById('denglu_zhanghao').value.trim();
            const mima = document.getElementById('denglu_mima').value;
            if (!zhanghao || !mima) return rizhi('账号或密码不能为空', 'warn');
            const jieguo = await kehu.dengluqingqiu(zhanghao, mima);
            rizhi('登录结果: ' + jieguo, 'ok');
        });

        window.qingkongrizhi = function() {
            document.getElementById('rizhi').innerHTML = '';
        };

        window.sse_huidiao = function(shuju) {
            rizhi('SSE: ' + shuju, 'info');
        };

        window.aiduihua_liushi_huidiao = function(shuju) {
            if (aiduihua_jm) {
                aiduihua_jm.liushihuidiao(shuju);
            }
        };

        window.aiduihua_duquqi_huidiao = function(controller) {
            console.log('[DEBUG] aiduihua_duquqi_huidiao 被调用');
            console.log('[DEBUG] controller 参数:', controller);
            if (aiduihua_jm && aiduihua_jm.luoji) {
                aiduihua_jm.luoji.baocunduquqi(controller);
            } else {
                console.error('[DEBUG] aiduihua_jm 或 aiduihua_jm.luoji 不存在');
            }
        };

        window.aiqudao_shuaxin = () => { if (aiqudao_jm) aiqudao_jm.shuaxinliebiao(); };
        window.aiqudao_xinzengshitu = () => { if (aiqudao_jm) aiqudao_jm.xuanranxinzengbiaodan(); };
        window.aiqudao_tijiaoxinzeng = () => { if (aiqudao_jm) aiqudao_jm.tijiaoxinzeng(); };
        window.aiqudao_qiehuan = (id) => { if (aiqudao_jm) aiqudao_jm.qiehuanzhuangtai(id); };
        window.aiqudao_shanchu = (id) => { if (aiqudao_jm) aiqudao_jm.shanchuid(id); };
        window.aiqudao_bianji = (id) => { if (aiqudao_jm) aiqudao_jm.bianji(id); };
        window.aiqudao_tijiaobian = () => { if (aiqudao_jm) aiqudao_jm.tijiaobian(); };

        window.aiduihua_fasong = () => { if (aiduihua_jm) aiduihua_jm.fasong(); };
        window.aiduihua_zhongzhi = () => { if (aiduihua_jm) aiduihua_jm.zhongzhi(); };
        window.aiduihua_qiehuanmoshi = (moshi) => { if (aiduihua_jm) aiduihua_jm.qiehuanmoshi(moshi); };
        window.aiduihua_qingkonglishi = () => { if (aiduihua_jm) aiduihua_jm.qingkonglishi(); };
        window.aiduihua_shanchuxiaoxi = (idx) => { if (aiduihua_jm) aiduihua_jm.shanchuxiaoxi(idx); };
        window.aiduihua_daochulishi = () => { if (aiduihua_jm) aiduihua_jm.daochulishi(); };
        window.aiduihua_xinjianhiuhua = () => { if (aiduihua_jm) aiduihua_jm.xinjianhiuhua(); };
        window.aiduihua_qiehuanhuihua = (id) => { if (aiduihua_jm) aiduihua_jm.qiehuanhuihua(id); };
        window.aiduihua_shanchuhuihua = (id) => { if (aiduihua_jm) aiduihua_jm.shanchuhuihua(id); };
        window.aiduihua_chongmingming = (id) => { if (aiduihua_jm) aiduihua_jm.chongmingming(id); };
        }).catch(err => {
            console.error('模块加载失败:', err);
            rizhi('模块加载失败: ' + err.message, 'err');
        });
    </script>
</body>
</html>
