<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>加密传输测试</title>
    <link rel="stylesheet" href="./yangshi.css">
</head>

<body>
    <h1>AI日报系统-SDK</h1>

    <div class="card">
        <h2>SDK连接状态</h2>
        <p>SDK: <span id="wasm_zhuangtai" class="zhuangtai weilianjiecheng">加载中...</span></p>
    </div>

    <div class="card">
        <h2>请求测试</h2>
        <button id="btn_jiankang" onclick="jiankangqingqiu()" disabled>普通健康检查</button>
        <button id="btn_jiamiqingqiu" onclick="jiamijiankangqingqiu()" disabled>加密健康测试</button>
        <button id="btn_sseceshi" onclick="sseceshiqingqiu()" disabled>普通SSE测试</button>
        <button id="btn_jiamisseceshi" onclick="jiamisseceshiqingqiu()" disabled>加密SSE测试</button>
        <button id="btn_chongzhi" onclick="chongzhihuihua()" disabled>重置会话</button>
    </div>

    <div class="card">
        <h2>登录测试</h2>
        <div class="shurukuang">
            <div class="shuruxiang">
                <label for="denglu_zhanghao">账号</label>
                <input id="denglu_zhanghao" type="text" value="xiaoluo" placeholder="请输入账号">
            </div>
            <div class="shuruxiang">
                <label for="denglu_mima">密码</label>
                <input id="denglu_mima" type="password" value="5201314" placeholder="请输入密码">
            </div>
            <div class="shuruxiang">
                <label style="visibility:hidden">占位</label>
                <button id="btn_denglu" onclick="dengluqingqiu()" disabled>加密登录</button>
            </div>
        </div>
    </div>

    <div class="card" id="yonghu_mianban"></div>

    <div class="card">
        <h2>日志</h2>
        <button class="rizhi-qingkong" onclick="qingkongrizhi()">清空</button>
        <div id="rizhi" class="log"></div>
    </div>

    <div class="card" id="aiqudao_mianban"></div>

    <div class="card" id="ribao_mianban"></div>

    <div class="card" id="biaoqian_mianban"></div>

    <div class="card" id="aiduihua_mianban"></div>

    <script type="module">
        const v = Date.now();
        import(`./pkg/wasm_sdk.js?v=${v}`).then(module => {
            return Promise.all([
                module,
                import(`./aiqudao_luoji.js?v=${v}`),
                import(`./aiqudao_jiemian.js?v=${v}`),
                import(`./aiduihua_luoji.js?v=${v}`),
                import(`./aiduihua_jiemian.js?v=${v}`),
                import(`./ribao_luoji.js?v=${v}`),
                import(`./ribao_jiemian.js?v=${v}`),
                import(`./biaoqian_jiemian.js?v=${v}`),
                import(`./yonghu_luoji.js?v=${v}`),
                import(`./yonghu_jiemian.js?v=${v}`)
            ]);
        }).then(([wasm, aiqudaoluoji, aiqudaojiemian, aiduihualuoji, aiduihuajiemian, ribaoluoji, ribaojiemian, biaoqianjiemian, yonghuluoji, yonghujiemian]) => {
            const { default: init, Kehuduanjiami } = wasm;
            const { Aiqudaoluoji } = aiqudaoluoji;
            const { Aiqudaojiemian } = aiqudaojiemian;
            const { Aiduihualuoji } = aiduihualuoji;
            const { Aiduihuajiemian } = aiduihuajiemian;
            const { Ribaoluoji } = ribaoluoji;
            const { Ribaojiemian } = ribaojiemian;
            const { Biaoqianjiemian } = biaoqianjiemian;
            const { Yonghuluoji } = yonghuluoji;
            const { Yonghujiemian } = yonghujiemian;

            const fuwuqidizhi = 'http://127.0.0.1:8889';
            let kehu = null;
            let aiqudao_jm = null;
            let ribao_jm = null;
            let biaoqian_jm = null;
            let aiduihua_jm = null;
            let yonghu_jm = null;

            function rizhi(neirong, leixing = '') {
                const el = document.getElementById('rizhi');
                const shijian = new Date().toLocaleTimeString();
                const leixingclass = leixing ? ` class="${leixing}"` : '';
                el.innerHTML += `<span style="color:#64748B">[${shijian}]</span> <span${leixingclass}>${neirong}</span>\n`;
                el.scrollTop = el.scrollHeight;
            }

            function gengxinzhuangtai(id, wenben, chenggong) {
                const el = document.getElementById(id);
                el.textContent = wenben;
                el.className = 'zhuangtai ' + (chenggong ? 'lianjiecheng' : 'weilianjiecheng');
            }

            let mianbanjiazai = false;

            async function chushihuamianban(shifouquanxian) {
                if (mianbanjiazai) return;
                mianbanjiazai = true;
                try {
                    const yonghu_lj = new Yonghuluoji(kehu, rizhi);
                    yonghu_jm = new Yonghujiemian(yonghu_lj, 'yonghu_mianban');
                    yonghu_jm.xuanran();
                    const aiqudao_lj = new Aiqudaoluoji(kehu, rizhi);
                    aiqudao_jm = new Aiqudaojiemian(aiqudao_lj, 'aiqudao_mianban');
                    await aiqudao_jm.xuanran();
                    const ribao_lj = new Ribaoluoji(kehu, rizhi, shifouquanxian || false);
                    ribao_jm = new Ribaojiemian(ribao_lj, 'ribao_mianban');
                    await ribao_jm.xuanran();
                    biaoqian_jm = new Biaoqianjiemian(ribao_lj, 'biaoqian_mianban');
                    await biaoqian_jm.chushihua();
                    const aiduihua_lj = new Aiduihualuoji(kehu, rizhi);
                    aiduihua_jm = new Aiduihuajiemian(aiduihua_lj, 'aiduihua_mianban');
                    await aiduihua_jm.xuanran();
                } catch (e) {
                    rizhi('面板初始化失败: ' + e, 'err');
                }
            }

            async function zidongchushihua() {
                try {
                    await init();
                    kehu = new Kehuduanjiami(fuwuqidizhi);
                    gengxinzhuangtai('wasm_zhuangtai', '已就绪', true);
                    rizhi('WASM 自动加载成功，服务器: ' + fuwuqidizhi, 'ok');
                    ['btn_jiamiqingqiu', 'btn_sseceshi', 'btn_jiamisseceshi', 'btn_chongzhi', 'btn_denglu']
                        .forEach(id => document.getElementById(id).disabled = false);
                    if (kehu.yidenglu()) {
                        rizhi('检测到已保存的登录令牌，自动恢复登录状态', 'info');
                        let zidongquanxian = false;
                        try {
                            const lingpai = localStorage.getItem('lingpai') || '';
                            const zaiti = JSON.parse(atob(lingpai.split('.')[1]));
                            zidongquanxian = zaiti?.yonghuzuid === '1';
                        } catch (_) {}
                        await chushihuamianban(zidongquanxian);
                    } else {
                        rizhi('请先登录以加载各功能面板', 'warn');
                    }
                } catch (e) {
                    gengxinzhuangtai('wasm_zhuangtai', '加载失败', false);
                    rizhi('WASM 加载失败: ' + e, 'err');
                }
            }

            zidongchushihua();

            function chuangjiantanchuang(peizhi) {
                return new Promise(jiejue => {
                    const zhezhao = document.createElement('div');
                    zhezhao.className = 'tc-zhezhao';
                    const tubiaolei = peizhi.leixing === 'weixian' ? 'tc-tubiao-hong' : peizhi.leixing === 'jinggao' ? 'tc-tubiao-huang' : 'tc-tubiao-lan';
                    const tubiaosvg = peizhi.leixing === 'weixian'
                        ? '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg>'
                        : peizhi.leixing === 'shuru'
                            ? '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>'
                            : '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';
                    const anlei = peizhi.leixing === 'weixian' ? 'tc-an-weixian' : 'tc-an-queren';
                    const anwenzi = peizhi.querenwenzi || (peizhi.leixing === 'weixian' ? '确认删除' : '确定');
                    let shuruhtml = '';
                    if (peizhi.leixing === 'shuru') {
                        shuruhtml = `<input class="tc-shuru" id="tc_shuru_kuang" type="text" value="${peizhi.morenzhi || ''}" placeholder="${peizhi.placeholder || ''}" autofocus>`;
                    }
                    zhezhao.innerHTML = `<div class="tc-ka"><div class="tc-tou"><div class="tc-tubiao ${tubiaolei}">${tubiaosvg}</div><div class="tc-biaoti">${peizhi.biaoti}</div></div><div class="tc-neirong">${peizhi.neirong || ''}${shuruhtml}</div><div class="tc-dibu"><button class="tc-an tc-an-quxiao" id="tc_quxiao">取消</button><button class="tc-an ${anlei}" id="tc_queren">${anwenzi}</button></div></div>`;
                    document.body.appendChild(zhezhao);
                    const guanbi = (zhi) => { zhezhao.remove(); jiejue(zhi); };
                    zhezhao.querySelector('#tc_quxiao').onclick = () => guanbi(null);
                    zhezhao.querySelector('#tc_queren').onclick = () => {
                        if (peizhi.leixing === 'shuru') {
                            guanbi(zhezhao.querySelector('#tc_shuru_kuang').value);
                        } else {
                            guanbi(true);
                        }
                    };
                    zhezhao.addEventListener('click', e => { if (e.target === zhezhao) guanbi(null); });
                    const shurukuang = zhezhao.querySelector('#tc_shuru_kuang');
                    if (shurukuang) {
                        shurukuang.focus();
                        shurukuang.select();
                        shurukuang.addEventListener('keydown', e => { if (e.key === 'Enter') zhezhao.querySelector('#tc_queren').click(); });
                    }
                    document.addEventListener('keydown', function esc(e) {
                        if (e.key === 'Escape') { document.removeEventListener('keydown', esc); guanbi(null); }
                    });
                });
            }

            window.aqqueren = (biaoti, neirong, leixing) => chuangjiantanchuang({ biaoti, neirong, leixing: leixing || 'weixian' });
            window.aqshuru = (biaoti, neirong, morenzhi, placeholder) => chuangjiantanchuang({ biaoti, neirong, leixing: 'shuru', morenzhi, placeholder });

            async function zhixinganniu(anniuid, caozuo) {
                if (!kehu) return rizhi('尚未初始化', 'warn');
                const btn = document.getElementById(anniuid);
                btn.disabled = true;
                try {
                    await caozuo();
                } catch (e) {
                    rizhi('请求失败: ' + e, 'err');
                } finally {
                    btn.disabled = false;
                }
            }

            window.chongzhihuihua = function () {
                if (!kehu) return;
                kehu.chongzhihuihua();
                rizhi('会话已重置，下次加密请求将自动重新协商', 'warn');
            };

            window.jiankangqingqiu = () => zhixinganniu('btn_jiankang', async () => {
                const jieguo = await kehu.jiankangqingqiu();
                rizhi('健康检查: ' + jieguo, 'ok');
            });

            window.jiamijiankangqingqiu = () => zhixinganniu('btn_jiamiqingqiu', async () => {
                const jieguo = await kehu.jiamijiankangqingqiu("你好加密传输");
                rizhi('加密响应: ' + jieguo, 'ok');
            });

            window.sseceshiqingqiu = () => zhixinganniu('btn_sseceshi', async () => {
                rizhi('--- 普通SSE开始 ---', 'info');
                await kehu.sseceshiqingqiu('sse_huidiao');
                rizhi('--- 普通SSE结束 ---', 'info');
            });

            window.jiamisseceshiqingqiu = () => zhixinganniu('btn_jiamisseceshi', async () => {
                rizhi('--- 加密SSE开始 ---', 'info');
                await kehu.jiamisseceshiqingqiu('sse_huidiao');
                rizhi('--- 加密SSE结束 ---', 'info');
            });

            window.dengluqingqiu = () => zhixinganniu('btn_denglu', async () => {
                const zhanghao = document.getElementById('denglu_zhanghao').value.trim();
                const mima = document.getElementById('denglu_mima').value;
                if (!zhanghao || !mima) return rizhi('账号或密码不能为空', 'warn');
                const jieguo = await kehu.dengluqingqiu(zhanghao, mima);
                rizhi('登录结果: ' + jieguo, 'ok');
                let shifouquanxian = false;
                try {
                    const jieguozhi = JSON.parse(jieguo);
                    const yonghuzuid = jieguozhi?.shuju?.yonghuzuid || '';
                    shifouquanxian = yonghuzuid === '1';
                } catch (_) { }
                if (!mianbanjiazai) {
                    await chushihuamianban(shifouquanxian);
                } else if (ribao_jm) {
                    ribao_jm.shezhiquanxian(shifouquanxian);
                }
            });

            function bangding(duixiangfn, yingshe) {
                for (const [mingcheng, fangfa] of Object.entries(yingshe)) {
                    window[mingcheng] = (...canshu) => {
                        const dx = duixiangfn();
                        if (dx) dx[fangfa](...canshu);
                    };
                }
            }

            window.yonghu_shuaxin = () => { if (yonghu_jm) { yonghu_jm.xuanran(); yonghu_jm.dangqianshitu === 'yonghu' ? yonghu_jm.shuaxinliebiao() : yonghu_jm.shuaxinyonghuzuliebiao(); } };
            bangding(() => yonghu_jm, {
                yonghu_qiehuanshitu: 'qiehuanshitu',
                yonghu_sousuo: 'sousuo',
                yonghu_qingkong: 'qingkong',
                yonghu_xiangqing: 'xiangqing',
                yonghu_shangyiye: 'shangyiye',
                yonghu_xiayiye: 'xiayiye',
                yonghu_tongyi_baocun: 'tongyi_baocun',
                yonghu_fengjin: 'fengjin_yonghu',
                yonghu_jiefeng: 'jiefeng_yonghu',
                yonghu_xinzeng_shitu: 'xinzeng_shitu',
                yonghu_tijiaoxinzeng: 'tijiaoxinzeng',
                yonghu_shanchu: 'shanchu_yonghu',
                yonghu_quanxuan: 'quanxuan_yonghu',
                yonghu_piliangshanchu: 'piliangshanchu_yonghu',
                yonghuzu_shuaxin: 'shuaxinyonghuzuliebiao',
                yonghuzu_sousuo: 'yonghuzu_sousuo',
                yonghuzu_qingkong: 'yonghuzu_qingkong',
                yonghuzu_xinzeng_shitu: 'yonghuzu_xinzeng_shitu',
                yonghuzu_tijiaoxinzeng: 'yonghuzu_tijiaoxinzeng',
                yonghuzu_bianji: 'yonghuzu_bianji',
                yonghuzu_tijiaobian: 'yonghuzu_tijiaobian',
                yonghuzu_shanchu: 'yonghuzu_shanchu',
                yonghuzu_shangyiye: 'yonghuzu_shangyiye',
                yonghuzu_xiayiye: 'yonghuzu_xiayiye',
                yonghuzu_baocunquanxian: 'yonghuzu_baocunquanxian',
                yonghuzu_quanxuan: 'quanxuan_yonghuzu',
                yonghuzu_piliangshanchu: 'piliangshanchu_yonghuzu',
            });

            window.qingkongrizhi = () => { document.getElementById('rizhi').innerHTML = ''; };
            window.sse_huidiao = (shuju) => { rizhi('SSE: ' + shuju, 'info'); };

            window.aiduihua_liushi_huidiao = (shuju) => { if (aiduihua_jm) aiduihua_jm.liushihuidiao(shuju); };
            window.aiduihua_duquqi_huidiao = (controller) => {
                if (aiduihua_jm && aiduihua_jm.luoji) {
                    aiduihua_jm.luoji.baocunduquqi(controller);
                }
            };

            bangding(() => aiqudao_jm, {
                aiqudao_shuaxin: 'shuaxinliebiao',
                aiqudao_xinzengshitu: 'xuanranxinzengbiaodan',
                aiqudao_tijiaoxinzeng: 'tijiaoxinzeng',
                aiqudao_qiehuan: 'qiehuanzhuangtai',
                aiqudao_shanchu: 'shanchuid',
                aiqudao_bianji: 'bianji',
                aiqudao_tijiaobian: 'tijiaobian',
                aiqudao_quanxuan: 'quanxuan',
                aiqudao_piliangshanchu: 'piliangshanchu',
            });

            bangding(() => aiduihua_jm, {
                aiduihua_fasong: 'fasong',
                aiduihua_zhongzhi: 'zhongzhi',
                aiduihua_qiehuanmoshi: 'qiehuanmoshi',
                aiduihua_qingkonglishi: 'qingkonglishi',
                aiduihua_shanchuxiaoxi: 'shanchuxiaoxi',
                aiduihua_daochulishi: 'daochulishi',
                aiduihua_xinjianhiuhua: 'xinjianhiuhua',
                aiduihua_qiehuanhuihua: 'qiehuanhuihua',
                aiduihua_shanchuhuihua: 'shanchuhuihua',
                aiduihua_chongmingming: 'chongmingming',
            });

            window.ribao_shuaxin = () => {
                if (ribao_jm) {
                    ribao_jm.sousuobiaoqianid = null;
                    ribao_jm.sousuoleixing = null;
                    ribao_jm.sousuoguanjiancizhi = null;
                    ribao_jm.sousuoyonghuid = null;
                    ribao_jm.dangqianyeshu = 1;
                    ribao_jm.shuaxindangqianshitu();
                }
            };
            bangding(() => ribao_jm, {
                ribao_qiehuanshitu: 'qiehuanshitu',
                ribao_xinzengshitu: 'xinzengshitu',
                ribao_tijiaoxinzeng: 'tijiaoxinzeng',
                ribao_shanchu: 'shanchuribao',
                ribao_bianji: 'bianji',
                ribao_ribao_quanxuan: 'quanxuan_ribao',
                ribao_ribao_piliangshanchu: 'piliangshanchu_ribao',
                ribao_biaoqian_quanxuan: 'quanxuan_biaoqian',
                ribao_biaoqian_piliangshanchu: 'piliangshanchu_biaoqian',
                ribao_leixing_quanxuan: 'quanxuan_leixing',
                ribao_leixing_piliangshanchu: 'piliangshanchu_leixing',
                ribao_renwu_quanxuan: 'quanxuan_renwu',
                ribao_renwu_piliangshanchu: 'piliangshanchu_renwu',
                ribao_tijiaobianji: 'tijiaobianji',
                ribao_guanlianguanlian: 'guanlianguanlian',
                ribao_shangyiye: 'shangyiye',
                ribao_xiayiye: 'xiayiye',
                ribao_xinzengbiaoqian: 'xinzengbiaoqian',
                ribao_tijiaoxinzengbiaoqian: 'tijiaoxinzengbiaoqian',
                ribao_shanchubiaoqian: 'shanchubiaoqian',
                ribao_bianjibiaoqian: 'bianjibiaoqian',
                ribao_xinzengleixing: 'xinzengleixing',
                ribao_tijiaoxinzengleixing: 'tijiaoxinzengleixing',
                ribao_shanchuleixing: 'shanchuleixing',
                ribao_bianjileixing: 'bianjileixing',
                ribao_xinzengguanlian: 'xinzengguanlian',
                ribao_shanchuguanlian: 'shanchuguanlian',
                ribao_quxiao: 'quxiao',
                ribao_sousuoguanjianci: 'sousuoguanjianci',
                ribao_sousuoshuru_huiche: 'sousuoshuru_huiche',
                ribao_sousuobiaoqian_xuanze: 'sousuobiaoqian_xuanze',
                ribao_sousuoyonghuid_xuanze: 'sousuoyonghuid_xuanze',
                ribao_dianjibibaoqian: 'dianjibibaoqian',
                ribao_qingchusousuo: 'qingchusousuo',
                ribao_chakanguanlian: 'chakanguanlian',
                ribao_chakanleixingribao: 'chakanleixingribao',
                ribao_qiehuanneirong: 'qiehuanneirong',
                ribao_chongxinruidui: 'chongxinruidui',
                ribao_shanchurenwu: 'shanchurenwu',
                ribao_xinzengrenwu: 'xinzengrenwu',
                ribao_renwu_qidong: 'renwu_qidong',
                ribao_renwu_tingzhi: 'renwu_tingzhi',
                ribao_qiehuanquanbu: 'qiehuanquanbu',
                ribao_renwu_shaixuan: 'renwu_shaixuan',
                ribao_renwu_shangyiye: 'renwu_shangyiye',
                ribao_renwu_xiayiye: 'renwu_xiayiye',
                ribao_siweidaotu: 'siweidaotu',
                ribao_guanbisiweidaotu: 'guanbisiweidaotu',
                ribao_xiazaisiweidaotu: 'xiazaisiweidaotu',
                ribao_tupu_jiazai: '_tupu_jiazai',
                ribao_tupu_sousuo_shuru: 'tupu_sousuo_shuru',
                ribao_tupu_sousuo_xuanze: 'tupu_sousuo_xuanze',
                ribao_tupu_celan_shangyiye: 'tupu_celan_shangyiye',
                ribao_tupu_celan_xiayiye: 'tupu_celan_xiayiye',
                ribao_tupu_chakanribao: 'tupu_chakanribao',
                ribao_tupu_jiazai_biaoqianid_celan: '_tupu_jiazai_biaoqianid',
                ribao_guanxifenxi: 'guanxifenxi',
                ribao_piliang_xinzengrenwu: 'piliang_xinzengrenwu',
                ribao_tiaozhuan_tupu: 'tiaozhuan_tupu',
                ribao_biaoqian_tiaozhuan_tupu: 'biaoqian_tiaozhuan_tupu',
            });

            bangding(() => biaoqian_jm, {
                biaoqian_shuaxin: 'shuaxin',
                biaoqian_qiehuanshitu: 'qiehuanshitu',
                biaoqian_xinzengleixing: 'xinzengleixing',
                biaoqian_bianjileixing: 'bianjileixing',
                biaoqian_shanchuleixing: 'shanchuleixing',
                biaoqian_bianjibiaoqian: 'bianjibiaoqian',
                biaoqian_xinzengbiaoqian: 'xinzengbiaoqian',
                biaoqian_xinzengbiaoqian_leixing: 'xinzengbiaoqian_leixing',
                biaoqian_bianjibiaoqian_danxiang: 'bianjibiaoqian_danxiang',
                biaoqian_shanchubiaoqian: 'shanchubiaoqian',
                biaoqian_fanhui: 'fanhui',
                biaoqian_quxiao: 'quxiao',
                biaoqian_tijiaoxinzengleixing: 'tijiaoxinzengleixing',
                biaoqian_tijiaobjleixing: 'tijiaobjleixing',
                biaoqian_tijiaoxinzengbiaoqian: 'tijiaoxinzengbiaoqian',
                biaoqian_tijiaoxinzengbiaoqian_leixing: 'tijiaoxinzengbiaoqian_leixing',
                biaoqian_tijiaobjbiaoqian: 'tijiaobjbiaoqian',
                biaoqian_fanhuileixing: 'fanhuileixing',
                biaoqian_piliangshanchu_leixing: 'piliangshanchu_leixing',
                biaoqian_piliangshanchu_biaoqian: 'piliangshanchu_biaoqian',
            });
        }).catch(err => {
            console.error('模块加载失败:', err);
        });
    </script>
</body>

</html>