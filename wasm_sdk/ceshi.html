<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>加密传输测试</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans SC', Inter, sans-serif; background: #F8FAFC; color: #1E293B; padding: 24px; line-height: 1.6; }
        h1 { font-size: 20px; margin-bottom: 20px; color: #0F172A; }
        .card { background: rgba(255,255,255,0.9); border: 1px solid #E2E8F0; border-radius: 12px; padding: 20px; margin-bottom: 16px; }
        .card h2 { font-size: 15px; color: #475569; margin-bottom: 12px; }
        button { background: #3B82F6; color: #fff; border: none; border-radius: 8px; padding: 10px 20px; font-size: 14px; cursor: pointer; transition: background-color 200ms; min-height: 44px; margin-right: 8px; margin-bottom: 8px; }
        button:hover { background: #2563EB; }
        button:focus { outline: none; box-shadow: 0 0 0 2px #3B82F6; }
        button:disabled { background: #94A3B8; cursor: not-allowed; }
        .log { background: #0F172A; color: #E2E8F0; border-radius: 8px; padding: 16px; font-family: 'JetBrains Mono', monospace; font-size: 13px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; margin-top: 12px; }
        .ok { color: #10B981; }
        .err { color: #EF4444; }
        .info { color: #3B82F6; }
        .warn { color: #F59E0B; }
        .zhuangtai { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .zhuangtai.lianjiecheng { background: #D1FAE5; color: #065F46; }
        .zhuangtai.weilianjiecheng { background: #FEE2E2; color: #991B1B; }
    </style>
</head>
<body>
    <h1>加密传输测试面板</h1>

    <div class="card">
        <h2>连接状态</h2>
        <p>WASM: <span id="wasm_zhuangtai" class="zhuangtai weilianjiecheng">加载中...</span></p>
    </div>

    <div class="card">
        <h2>请求测试</h2>
        <button id="btn_jiankang" onclick="jiankangqingqiu()" disabled>普通健康检查</button>
        <button id="btn_jiamiqingqiu" onclick="jiamijiankangqingqiu()" disabled>加密健康测试</button>
        <button id="btn_chongzhi" onclick="chongzhihuihua()" disabled>重置会话</button>
    </div>

    <div class="card">
        <h2>日志</h2>
        <button onclick="qingkongrizhi()" style="background:#64748B;font-size:12px;padding:6px 14px;min-height:36px">清空</button>
        <div id="rizhi" class="log"></div>
    </div>

    <script type="module">
        import init, { Kehuduanjiami } from './pkg/wasm_sdk.js';

        const fuwuqidizhi = 'http://127.0.0.1:8889';
        let kehu = null;

        function rizhi(neirong, leixing = '') {
            const el = document.getElementById('rizhi');
            const shijian = new Date().toLocaleTimeString();
            const leixingclass = leixing ? ` class="${leixing}"` : '';
            el.innerHTML += `<span style="color:#64748B">[${shijian}]</span> <span${leixingclass}>${neirong}</span>\n`;
            el.scrollTop = el.scrollHeight;
        }

        function gengxinzhuangtai(id, wenben, chenggong) {
            const el = document.getElementById(id);
            el.textContent = wenben;
            el.className = 'zhuangtai ' + (chenggong ? 'lianjiecheng' : 'weilianjiecheng');
        }

        async function zidongchushihua() {
            try {
                await init();
                kehu = new Kehuduanjiami(fuwuqidizhi);
                gengxinzhuangtai('wasm_zhuangtai', '已就绪', true);
                rizhi('WASM 自动加载成功，服务器: ' + fuwuqidizhi, 'ok');
                document.getElementById('btn_jiankang').disabled = false;
                document.getElementById('btn_jiamiqingqiu').disabled = false;
                document.getElementById('btn_chongzhi').disabled = false;
            } catch (e) {
                gengxinzhuangtai('wasm_zhuangtai', '加载失败', false);
                rizhi('WASM 加载失败: ' + e, 'err');
            }
        }

        zidongchushihua();

        async function zhixinganniu(anniuid, caozuo) {
            if (!kehu) return rizhi('尚未初始化', 'warn');
            const btn = document.getElementById(anniuid);
            btn.disabled = true;
            try {
                await caozuo();
            } catch (e) {
                rizhi('请求失败: ' + e, 'err');
            } finally {
                btn.disabled = false;
            }
        }

        window.chongzhihuihua = function() {
            if (!kehu) return;
            kehu.chongzhihuihua();
            rizhi('会话已重置，下次加密请求将自动重新协商', 'warn');
        };

        window.jiankangqingqiu = () => zhixinganniu('btn_jiankang', async () => {
            const jieguo = await kehu.jiankangqingqiu();
            rizhi('健康检查: ' + jieguo, 'ok');
        });

        window.jiamijiankangqingqiu = () => zhixinganniu('btn_jiamiqingqiu', async () => {
            const jieguo = await kehu.jiamijiankangqingqiu("你好加密传输");
            rizhi('加密响应: ' + jieguo, 'ok');
        });

        window.qingkongrizhi = function() {
            document.getElementById('rizhi').innerHTML = '';
        };

        window.sse_huidiao = function(shuju) {
            rizhi('SSE: ' + shuju, 'info');
        };
    </script>
</body>
</html>
