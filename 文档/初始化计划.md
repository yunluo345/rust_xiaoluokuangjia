# main.rs 初始化计划

## 概述

以下依赖需要在 main.rs 启动时进行初始化，按执行顺序排列。

---

## 第一步：加载配置系统（peizhi 模块）

- 必须最先执行，后续所有初始化都依赖配置值
- 按优先级加载 `config/default.toml` → `config/{env}.toml` → `config/local.toml`
- 通过环境变量 `RUN_ENV` 决定当前环境，默认 `dev`
- 配置加载失败直接 panic 终止启动
- 优先级：最高

## 第二步：初始化日志系统（tracing + tracing-subscriber）

- 在所有业务逻辑之前初始化，确保后续流程的日志都能被捕获
- 配置 `tracing_subscriber`，启用 `EnvFilter` 从环境变量 `RUST_LOG` 读取日志级别
- 优先级：高

## 第三步：连接数据库（sqlx）

- 从环境变量读取 `DATABASE_URL`
- 创建 `sqlx::PgPool` 或 `sqlx::SqlitePool` 连接池
- 可选：执行数据库迁移 `sqlx::migrate!()`
- 连接池作为共享状态注入 actix-web 的 `app_data`
- 优先级：高

## 第四步：连接向量数据库（qdrant-client）

- 从环境变量读取 Qdrant 地址（如 `QDRANT_URL`）
- 创建 `QdrantClient` 实例
- 作为共享状态注入 actix-web 的 `app_data`
- 优先级：高

## 第五步：配置 CORS 中间件（actix-cors）

- 在 actix-web App 构建时配置 `Cors`
- 设置允许的来源、方法、请求头
- 通过 `App::wrap(cors)` 注册
- 优先级：中

## 第六步：启动 Web 服务器（actix-web）

- 配置 `HttpServer`，绑定地址和端口
- 注册路由、中间件、共享状态
- 调用 `.run().await` 启动服务
- 优先级：中

---

## 无需在 main.rs 初始化的依赖

以下依赖在使用时按需调用即可，不需要全局初始化：

| 依赖 | 原因 |
|------|------|
| reqwest | 按需创建 Client，或在需要时构造一个全局 Client 注入 app_data |
| llm | 按需构建请求，无全局状态 |
| aes-gcm | 加解密时按需调用 |
| argon2 | 密码哈希时按需调用 |
| jsonwebtoken | 编解码 JWT 时按需调用，密钥从环境变量读取即可 |
| sha2 / hmac | 签名校验时按需调用 |
| x25519-dalek | 密钥协商时按需生成临时密钥对 |
| thiserror | 编译期派生宏，无运行时初始化 |
| validator | 编译期派生宏，无运行时初始化 |
| serde / serde_json | 编译期派生宏，无运行时初始化 |

---

## 初始化顺序总结

```
1. peizhi::jiazai()             → 加载配置系统
2. tracing_subscriber::init()   → 初始化日志
3. sqlx::PgPool::connect()      → 连接数据库
4. QdrantClient::new()          → 连接向量数据库
5. Cors::default()              → 配置跨域（在 App 构建时）
6. HttpServer::new().run()      → 启动 Web 服务
```

---

## 备注

- reqwest::Client 建议也在启动时创建一个全局实例注入 app_data，避免每次请求都新建连接池
- jsonwebtoken 的签名密钥建议启动时从环境变量读取一次，存入共享状态
- 所有连接类资源（数据库、Qdrant）失败时应直接 panic 终止启动，不要静默忽略
