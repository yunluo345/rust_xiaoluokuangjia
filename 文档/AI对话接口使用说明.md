# AI对话接口使用说明

## 接口概述

新增了两个AI对话接口，支持自动选择可用AI渠道，所有登录用户均可使用。

### 1. 非流式对话接口

**路径**: `/jiekou/ai/duihua`  
**方法**: POST  
**加密**: 是（需要先调用加密握手接口）  
**鉴权**: 需要登录（Bearer Token）

**请求格式**（加密前）:
```json
{
  "xiaoxilie": [
    {"juese": "user", "neirong": "你好"},
    {"juese": "assistant", "neirong": "你好！有什么可以帮助你的？"},
    {"juese": "user", "neirong": "介绍一下Rust语言"}
  ]
}
```

**响应格式**（解密后）:
```json
{
  "zhuangtaima": 200,
  "xiaoxi": "对话成功",
  "shijianchuo": 1234567890,
  "shuju": {
    "huifu": "Rust是一门系统编程语言..."
  }
}
```

### 2. 流式对话接口

**路径**: `/jiekou/ai/duihualiushi`  
**方法**: POST  
**加密**: 是（需要先调用加密握手接口）  
**鉴权**: 需要登录（Bearer Token）  
**响应类型**: SSE (Server-Sent Events)

**请求格式**（加密前）:
```json
{
  "xiaoxilie": [
    {"juese": "user", "neirong": "介绍一下Rust语言"}
  ]
}
```

**响应格式**（每条SSE消息解密后）:
```json
{"neirong": "Rust"}
{"neirong": "是"}
{"neirong": "一门"}
...
```

**错误响应**（解密后）:
```json
{"cuowu": "错误信息"}
```

## 使用流程

1. **获取加密会话密钥**
   - 调用 `/jiekou/jiami/gongyao` 获取加密会话

2. **用户登录**
   - 调用 `/jiekou/yonghu/denglu` 获取JWT令牌

3. **调用AI对话接口**
   - 在请求头添加 `Authorization: Bearer <token>`
   - 使用加密会话密钥加密请求体
   - 发送请求到对话接口
   - 解密响应内容

## 特性说明

- **自动渠道选择**: 后端自动从数据库获取可用的AI渠道（按优先级随机选择）
- **参数控制**: 不允许客户端注入系统提示词、温度等参数，由后端统一控制
- **加密传输**: 所有请求和响应均经过AES-GCM加密
- **权限控制**: 所有登录用户均可使用，无需特殊用户组权限
- **流式支持**: 流式接口实时推送AI响应，每条消息独立加密

## 错误码说明

- `400`: 请求参数格式错误或消息列表为空
- `401`: 加密会话无效或缺少授权令牌
- `500`: AI渠道不可用、配置错误或服务调用失败

## 注意事项

1. 流式接口返回的是SSE流，需要使用支持SSE的客户端
2. 每条SSE消息都是独立加密的，需要逐条解密
3. 对话历史需要客户端维护，每次请求需要传入完整的消息列表
4. 当前仅支持OpenAI类型的渠道
