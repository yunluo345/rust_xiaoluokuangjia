# 配置系统使用指南

## 概述

本框架的配置系统提供了自动同步、内存缓存、增量更新等功能，所有配置文件存储在 `peizhi/` 目录下，格式为 JSON。

## 快速开始

### 1. 读取配置

```rust
use peizhixt::peizhixitongzhuti;
use peizhixt::peizhi_nr::peizhi_zongpeizhi::Zongpeizhi;

// 读取总配置（优先从内存缓存读取）
if let Some(peizhi) = peizhixitongzhuti::duqupeizhi::<Zongpeizhi>(
    Zongpeizhi::wenjianming()
) {
    println!("网站名称: {}", peizhi.wangzhanmingcheng);
    println!("后端端口: {}", peizhi.houduanyunxingduankou);
}
```

### 2. 修改配置

直接编辑 `peizhi/zongpeizhi.json` 文件，重启程序即可生效。配置系统会自动：
- 保留你修改的值
- 补充新增的字段（使用默认值）
- 加载到内存缓存

## 添加新配置

### 步骤 1：创建配置结构体

在 `src/peizhixt/peizhi_nr/` 目录下创建新文件，例如 `peizhi_shujuku.rs`：

```rust
#![allow(non_upper_case_globals)]

use serde::{Deserialize, Serialize};

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Shujuku {
    pub zhiji: String,
    pub duankou: u16,
    pub yonghuming: String,
    pub mima: String,
}

impl Default for Shujuku {
    fn default() -> Self {
        Self {
            zhiji: "localhost".to_string(),
            duankou: 5432,
            yonghuming: "postgres".to_string(),
            mima: "".to_string(),
        }
    }
}

impl Shujuku {
    pub fn wenjianming() -> &'static str {
        "shujuku"
    }
}
```

**关键点：**
- 结构体必须实现 `Debug`、`Clone`、`Serialize`、`Deserialize`
- 必须实现 `Default` trait 提供默认值
- `wenjianming()` 方法返回配置文件名（不含 `.json` 后缀）
- 所有命名使用全小写拼音

### 步骤 2：注册模块

在 `src/peizhixt/peizhi_nr/mod.rs` 中添加：

```rust
pub mod peizhi_zongpeizhi;
pub mod peizhi_shujuku;  // 新增这行
```

### 步骤 3：在初始化中注册

编辑 `src/peizhixt/peizhixitongzhuti.rs`，在 `chushihua()` 函数中添加：

```rust
use super::peizhi_nr::peizhi_shujuku::Shujuku;  // 添加 import

pub fn chushihua() -> bool {
    tongbupeizhiwenjian::<Zongpeizhi>(Zongpeizhi::wenjianming())
        && tongbupeizhiwenjian::<Shujuku>(Shujuku::wenjianming())  // 新增这行
        && jiazaisuoyoupeizhi()
}
```

### 步骤 4：使用新配置

```rust
use peizhixt::peizhi_nr::peizhi_shujuku::Shujuku;

if let Some(shujuku) = peizhixitongzhuti::duqupeizhi::<Shujuku>(
    Shujuku::wenjianming()
) {
    println!("数据库主机: {}", shujuku.zhiji);
    println!("数据库端口: {}", shujuku.duankou);
}
```

## 配置文件位置

所有配置文件存储在项目根目录的 `peizhi/` 文件夹下：

```
项目根目录/
├── peizhi/
│   ├── zongpeizhi.json      # 总配置
│   ├── shujuku.json          # 数据库配置（示例）
│   └── ...                   # 其他配置
├── src/
└── Cargo.toml
```

## 配置文件格式

配置文件使用 JSON 格式，自动格式化（pretty print）：

```json
{
  "wangzhanmingcheng": "小落RUST后端框架",
  "houduanyunxingduankou": 8889
}
```

## 高级功能

### 热更新内存缓存

如果手动修改了配置文件，可以调用热更新方法刷新内存缓存：

```rust
use gongju::neicungongju;

// 重新加载所有已缓存的配置文件
neicungongju::regengxin();
```

### 手动加载配置到内存

```rust
use peizhixt::peizhixitongzhuti;

// 加载指定配置文件到内存
peizhixitongzhuti::jiazaidaohuancun("zongpeizhi");
```

### 直接操作内存缓存

```rust
use gongju::neicungongju;

// 读取
if let Some(neirong) = neicungongju::duqu("peizhi/zongpeizhi.json") {
    println!("配置内容: {}", neirong);
}

// 写入
neicungongju::xieru("peizhi/zongpeizhi.json", "{...}");

// 检查是否存在
if neicungongju::cunzai("peizhi/zongpeizhi.json") {
    println!("配置已缓存");
}
```

## 注意事项

1. **配置文件名规则**：`wenjianming()` 返回的名称会自动加上 `.json` 后缀
2. **字段命名**：所有字段名使用全小写拼音，不使用驼峰命名
3. **默认值**：`Default` trait 中的默认值会在配置文件缺失字段时自动补充
4. **类型安全**：配置结构体提供编译时类型检查，避免运行时错误
5. **性能优化**：初始化后所有配置在内存中，读取零 IO 开销

## 常见问题

### Q: 如何添加嵌套配置？

A: 在结构体中使用嵌套结构：

```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Shujuku {
    pub postgres: PostgresConfig,
    pub redis: RedisConfig,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct PostgresConfig {
    pub zhiji: String,
    pub duankou: u16,
}
```

### Q: 配置文件损坏怎么办？

A: 配置系统会自动处理：
- 如果 JSON 解析失败，会使用默认值重新生成
- 如果字段缺失，会自动补充默认值

### Q: 如何在不重启的情况下更新配置？

A: 修改配置文件后调用：

```rust
neicungongju::regengxin();  // 重新加载所有配置到内存
```

### Q: 配置文件可以手动删除吗？

A: 可以。下次启动时会自动用默认值重新创建。

## 相关文档

- [配置系统实现原理](./实现原理.md)
- [API 文档](./API文档.md)
