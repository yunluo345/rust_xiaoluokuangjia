# 日报系统数据库设计

## 日报表 (shujubiao_ribao)

存储用户发送的日报内容和时间信息。

| 字段名 | 昵称 | 说明 | 类型 | 默认值 |
|---|---|---|---|---|
| `id` | 日报ID | 日报唯一标识 | `BIGSERIAL PRIMARY KEY` | 无 |
| `yonghuid` | 用户ID | 发送日报的用户ID | `BIGINT NOT NULL` | 无 |
| `neirong` | 日报内容 | 日报的具体内容 | `TEXT NOT NULL` | 无 |
| `fabushijian` | 发布时间 | 日报发布的时间戳 | `TEXT NOT NULL` | 无 |
| `chuangjianshijian` | 创建时间 | 记录创建时间 | `TEXT NOT NULL` | 无 |
| `gengxinshijian` | 更新时间 | 记录最后更新时间 | `TEXT NOT NULL` | 无 |

## 标签类型表 (shujubiao_biaoqianleixing)

定义标签的分类类型，如"地名"、"项目名"等。

| 字段名 | 昵称 | 说明 | 类型 | 默认值 |
|---|---|---|---|---|
| `id` | 类型ID | 标签类型唯一标识 | `BIGSERIAL PRIMARY KEY` | 无 |
| `mingcheng` | 类型名称 | 标签类型的名称，如"地名" | `TEXT NOT NULL UNIQUE` | 无 |
| `chuangjianshijian` | 创建时间 | 记录创建时间 | `TEXT NOT NULL` | 无 |
| `gengxinshijian` | 更新时间 | 记录最后更新时间 | `TEXT NOT NULL` | 无 |

## 标签表 (shujubiao_biaoqian)

存储具体的标签值，归属于某个标签类型。

| 字段名 | 昵称 | 说明 | 类型 | 默认值 |
|---|---|---|---|---|
| `id` | 标签ID | 标签唯一标识 | `BIGSERIAL PRIMARY KEY` | 无 |
| `leixingid` | 类型ID | 所属的标签类型ID | `BIGINT NOT NULL` | 无 |
| `zhi` | 标签值 | 标签的具体值，如"广东"、"青岛" | `TEXT NOT NULL` | 无 |
| `chuangjianshijian` | 创建时间 | 记录创建时间 | `TEXT NOT NULL` | 无 |
| `gengxinshijian` | 更新时间 | 记录最后更新时间 | `TEXT NOT NULL` | 无 |

**约束：** `UNIQUE(leixingid, zhi)` - 同一类型下标签值唯一

## 日报标签关联表 (shujubiao_ribao_biaoqian)

建立日报与标签的多对多关联关系。

| 字段名 | 昵称 | 说明 | 类型 | 默认值 |
|---|---|---|---|---|
| `ribaoid` | 日报ID | 关联的日报ID | `BIGINT NOT NULL` | 无 |
| `biaoqianid` | 标签ID | 关联的标签ID | `BIGINT NOT NULL` | 无 |
| `chuangjianshijian` | 创建时间 | 记录创建时间 | `TEXT NOT NULL` | 无 |

**主键：** `PRIMARY KEY (ribaoid, biaoqianid)`

## 关联关系

```
用户表 (1) ──── (N) 日报表
  id       <────  yonghuid

标签类型表 (1) ──── (N) 标签表
  id         <────  leixingid

日报表 (N) ──── (N) 标签表
  id    <────┐         ┌────>  id
            └─ 关联表 ─┘
         ribaoid  biaoqianid
```

- 一个用户可以发送多条日报（一对多）
- 一个标签类型下可以有多个标签值（一对多）
- 一条日报可以有多个标签，一个标签可以关联多条日报（多对多）

## 使用场景

### 查询某个标签类型下的所有标签
```sql
SELECT b.* FROM shujubiao_biaoqian b
JOIN shujubiao_biaoqianleixing l ON b.leixingid = l.id
WHERE l.mingcheng = '地名';
```

### 查询包含某个标签的所有日报
```sql
SELECT r.* FROM shujubiao_ribao r
JOIN shujubiao_ribao_biaoqian rb ON r.id = rb.ribaoid
JOIN shujubiao_biaoqian b ON rb.biaoqianid = b.id
WHERE b.zhi = '广东';
```

### 查询某条日报的所有标签
```sql
SELECT b.*, l.mingcheng as leixing FROM shujubiao_biaoqian b
JOIN shujubiao_biaoqianleixing l ON b.leixingid = l.id
JOIN shujubiao_ribao_biaoqian rb ON b.id = rb.biaoqianid
WHERE rb.ribaoid = 1;
```

## 关系网逻辑（当前实现）

### 1. 系统里有两套“关系网”

1) **标签共现图谱（全局）**  
- 节点：标签（`biaoqian`）  
- 边：两个标签在同一条日报中共同出现（通过 `ribao_biaoqian` 关联得到）  
- 权重：共现次数（按不同 `ribaoid` 去重计数）

2) **人物关系分析（单日报）**  
- 来源：AI 按提示词分析日报正文得到 `guanxifenxi` JSON  
- 存储位置：`ribao.kuozhan.guanxifenxi`  
- 用途：前端“关系”弹窗展示，不参与全局图谱边计算

### 2. 标签图谱的建模与计算方式

- **节点查询**：从 `biaoqian` + `biaoqianleixing` 联表获取 `id / zhi / leixingmingcheng`。  
- **边查询**：在 `ribao_biaoqian` 上自连接，按 `rb1.biaoqianid < rb2.biaoqianid` 生成无向边，避免重复；`COUNT(DISTINCT rb1.ribaoid)` 作为权重。  
- **返回结构**：统一为：
```json
{"jiedian":[...], "bian":[{"yuan":"标签ID","mubiao":"标签ID","quanzhong":"共现次数"}]}
```

### 3. 图谱查询能力

- `tupu_quanbu`：查询全量标签图谱。  
- `tupu_biaoqianid`：以某标签为中心查询 1 层子图（中心 + 共现标签 + 子图内边）。  
- `tupu_leixingmingcheng`：按标签类型筛选图谱（保留涉及该类型的边）。

### 4. 关系网的数据更新链路（任务驱动）

1. 日报入库后创建/重置标签任务（`ribao_biaoqianrenwu`）。  
2. 调度器并发领取 `zhuangtai='false'` 且 `changshicishu < zuidachangshicishu` 的任务。  
3. 单任务处理中，AI提取标签（失败回退字符串规则提取）。  
4. 对每个提取项执行“类型存在则复用，不存在则创建；标签存在则复用，不存在则创建；日报-标签关联存在则跳过，不存在则绑定”。  
5. 成功后写回任务结果；并补充生成摘要、思维导图、人物关系分析（写入 `ribao.zhaiyao` 与 `ribao.kuozhan`）。

> 说明：全局图谱边不做单独持久化，查询时按当前 `ribao_biaoqian` 实时聚合计算。

### 5. 权限边界

- 图谱与任务处理能力在管理员接口 `/jiekou/ribao/guanli` 下。  
- 普通用户接口 `/jiekou/ribao/yonghu` 仅包含日报新增/查询/统计，不包含图谱与任务操作。

## 标签共现图谱增强方案（功能更全面）

### 0. 现状与主要痛点

- **可视化不够“可定位”**：想看「某个人 / 某个地点」时，需要在画布里肉眼找节点；目前缺少“搜索→定位→以此为中心加载子图”的闭环。
- **可追溯性不足**：图谱只能看“标签-标签”的边，**无法从节点/边直接查询对应日报列表**（实际工作里你最终还是要回到日报原文/摘要/导图）。
- **信息噪声大**：节点多时图谱拥挤；缺少按类型开关、按权重阈值、按时间范围的过滤，导致“看不清”。
- **重复代码多、扩展成本高**：后端图谱查询（全量/按类型/按ID子图）与前端图谱加载（全量/按类型/按ID子图）存在较多重复逻辑，后续每加一个图谱功能都要改多处。

### 1. 目标（你描述的需求落地成可验证目标）

1) **按“人/地点/客户”等入口快速聚焦**：输入关键词或选择类型后，1-2 步得到以该节点为中心的关系网。
2) **图谱 → 日报**：点击节点/边即可分页查看相关日报，支持继续打开日报的摘要/导图/关系分析。
3) **图谱更清晰**：提供过滤器（类型、最小权重、时间范围、只看自己/全局）+ 详情侧栏，让图谱从“好看”变成“可用”。
4) **代码可维护**：把图谱相关的重复实现收敛成“一个核心查询 + 多个参数化视图”。

### 2. 产品交互形态（建议）

在现有“图谱”视图基础上增强（不改变你现在的 Canvas 方案）：

- 顶部工具条：
  - **搜索框**：按 `标签值(zhi)` 模糊搜索（可选限定类型，如“我方人员/对方人员/地点/客户公司”）。
  - **过滤器**：类型多选（checkbox/chip）、最小权重滑块、时间范围（起止时间）、是否只看当前用户。
  - **视图模板**：`人物视图`（仅保留我方人员/对方人员相关边）、`地点视图`（仅保留地点相关边）、`全量视图`。

- 画布交互：
  - **单击节点**：选中并高亮；右侧打开【节点详情】（统计 + 相关日报列表）。
  - **双击节点**：以此节点为中心加载 `1-hop/2-hop` 子图（可配置默认 1-hop）。
  - **单击边**：右侧打开【边详情】（共现次数 + 共现日报列表）。

- 右侧详情栏（关键）：
  - 节点详情：类型、值、相关日报数、最近出现时间、Top 共现标签（按权重）。
  - 日报列表项：显示 `id / 发布时间 / 发布者 / 摘要(zhaiyao)`；按钮：`查看`、`导图`、`关系`。

> 说明：你现在已经有“导图/关系弹窗”能力（基于 `ribao.kuozhan`），图谱侧只需要把“日报列表→打开对应日报弹窗”串起来。

### 3. 后端接口增强（在 `/jiekou/ribao/guanli` 下新增 caozuo 草案）

> 现有能力里已经有：
> - `tupu_quanbu / tupu_biaoqianid / tupu_leixingmingcheng`（图谱）
> - `guanlian_chaxun_biaoqianid / guanlian_chaxun_leixingmingcheng_zhi`（按标签查日报）
>
> 但缺少“搜索定位 + 分页 + 边→日报 + 多标签交集”等关键拼图。

#### 3.1 节点搜索/定位
- caozuo：`tupu_sousuo`
- 参数：`{ guanjianci: string, leixingmingcheng?: string, limit?: number }`
- 返回（建议带上统计，便于排序）：
```json
{
  "liebiao": [
    {
      "biaoqianid": "123",
      "zhi": "张三",
      "leixingmingcheng": "我方人员",
      "ribao_zongshu": 18,
      "zuijin_fabushijian": "1739856000000"
    }
  ]
}
```

#### 3.2 子图查询增强（参数化替代多套接口）
- caozuo：`tupu_zitu`（新增；现有 `tupu_biaoqianid` 可继续保留做兼容）
- 参数：
  - `zhongxin_biaoqianid: string`
  - `shendu?: 1 | 2`（默认 1）
  - `leixingmingchenglie?: string[]`（类型白名单）
  - `min_quanzhong?: number`（过滤弱边）
  - `riqi_from?: string, riqi_to?: string`（按日报时间过滤边权的统计口径）
  - `zuida_jiedian?: number, zuida_bian?: number`（防止一次返回过大）

#### 3.3 节点 → 日报分页（图谱查日报的核心）
- caozuo：`tupu_ribao_fenye`
- 参数：`{ biaoqianid: string, yeshu: number, meiyetiaoshu: number, riqi_from?: string, riqi_to?: string }`
- 返回：`{ liebiao: [...], zongshu: number }`
- `liebiao` 建议包含：`id, fabushijian, yonghuid, fabuzhemingcheng, fabuzhezhanghao, zhaiyao, kuozhan`（或至少包含是否存在导图/关系的布尔值）。

#### 3.4 边 → 日报分页（两标签共现的日报）
- caozuo：`tupu_bian_ribao_fenye`
- 参数：`{ yuan_biaoqianid: string, mubiao_biaoqianid: string, yeshu: number, meiyetiaoshu: number, riqi_from?: string, riqi_to?: string }`
- SQL 语义：找同时满足 `rb1.biaoqianid=yuan` 且 `rb2.biaoqianid=mubiao` 的 `ribaoid`，再按时间分页取 `ribao`。

#### 3.5 多标签交集（更“实用”的分析入口）
- caozuo：`tupu_ribao_duobiaoqian_fenye`
- 参数：`{ biaoqianidlie: string[], yeshu: number, meiyetiaoshu: number }`
- 语义：返回“同时包含这些标签”的日报，用于“人+地点+客户公司”组合查询。

### 4. 数据与性能（让图谱可长期用）

- 建议补充索引（如果尚未建）：
  - `ribao_biaoqian(biaoqianid)`（节点→日报 / 边→日报 都依赖）
  - `ribao_biaoqian(ribaoid)`（自连接/聚合会用到）
  - `ribao(fabushijian)`（时间范围过滤、排序、分页）
- 图谱返回加阈值/分页思想：
  - `min_quanzhong`、`zuida_bian`、`zuida_jiedian` 是必要的“防爆”开关
- 可选高级优化：
  - 做一张 `标签共现边` 聚合表/物化视图（按天或按小时刷新），把实时 `COUNT(DISTINCT ribaoid)` 的成本移出请求链路。

### 5. 代码重构建议（解决“重复六级”问题的落点）

> 目标：把“同类逻辑散落在多处”的重复，收敛到少数核心函数/组件，后续加功能只改一处。

#### 5.1 后端 Rust（图谱查询去重）

当前 `shujucaozuo_ribao_biaoqian.rs` 里 `chaxun_tupu_quanbu / chaxun_tupu_biaoqianid / chaxun_tupu_leixingmingcheng` 结构高度相似（节点查询 + 边聚合 + 过滤差异）。建议：

- 抽一个核心函数（示意命名）：`chaxun_tupu(query: TupuQuery) -> Value`
- 三个现有函数只负责组装 `TupuQuery`，核心 SQL 在一个地方维护
- `chaxun_tupu_biaoqianid` 目前有“动态 IN 占位符拼接”，建议改为 CTE / 临时集合方案，避免重复拼 SQL/参数（也更不容易出错）

#### 5.2 前端 JS（图谱加载/渲染去重）

当前 `_tupu_jiazai / _tupu_jiazai_biaoqianid` 有重复的：加载态、错误态、解构响应、调用 `_tupu_xuanran`。建议：

- 合并成 `_tupu_jiazai_impl({ leixingmingcheng?, biaoqianid?, zhongxinid? })`
- “选中节点/边 → 右侧详情栏 → 日报列表 → 导图/关系弹窗”做成可复用的小组件/函数（避免后续再出现多层复制粘贴）。

### 6. 图谱 ↔ 日报 ↔ 导图/关系 的联动方式（关键路径）

- 数据来源：
  - 思维导图：`ribao.kuozhan.siweidaotu`
  - 人物关系分析：`ribao.kuozhan.guanxifenxi`
  - 摘要：`ribao.zhaiyao`
- 联动建议：
  1) 图谱侧获取日报列表（`tupu_ribao_fenye` / `tupu_bian_ribao_fenye`）
  2) 点击某条日报的“导图/关系”按钮：
     - 若列表里已返回 `kuozhan`，可直接复用现有弹窗逻辑
     - 否则调用 `ribao_chaxun_id` 拉完整数据，再打开现有 `siweidaotu()` / `guanxifenxi()` 弹窗

### 7. 建议落地顺序（最小可用 → 完整）

1) **先做“能定位 + 能追溯日报”**：`tupu_sousuo` + `tupu_ribao_fenye` + `tupu_bian_ribao_fenye` + 前端侧栏。
2) **再做“更清晰”**：类型开关、最小权重、时间范围、子图深度。
3) **最后做“更聪明/更快”**：物化边、路径/聚类、更多统计面板。
