# 标签共现图谱增强 — 实施计划

## 阶段一：后端图谱查询去重重构 ✅
> 目标：消除 3 个图谱函数的重复 SQL，为后续新接口打好基础。

### 1.1 抽取核心图谱查询函数
- 文件：`src/shujuku/psqlshujuku/shujubiao_nr/ribao/shujucaozuo_ribao_biaoqian.rs`
- 定义 `TupuCanshu` 结构体：
  - `jiedian_tiaojian: Option<String>`（节点 WHERE 子句片段）
  - `jiedian_canshu: Vec<String>`（节点查询参数）
  - `bian_tiaojian: Option<String>`（边额外 WHERE 子句片段）
  - `bian_canshu: Vec<String>`（边查询参数）
  - `zhongxin_biaoqianidlie: Option<Vec<String>>`（子图模式：限定边的节点范围）
- 实现 `chaxun_tupu_hexin(canshu: &TupuCanshu) -> Option<Value>`，内部统一组装：
  - 节点 SQL：`SELECT b.id, b.zhi, b.leixingid, l.mingcheng AS leixingmingcheng FROM biaoqian b JOIN biaoqianleixing l ON ... [WHERE ...]`
  - 边 SQL：自连接 + `GROUP BY` + 可选 `WHERE IN` / 类型过滤
  - 返回 `{"jiedian": [...], "bian": [...]}`

### 1.2 改写现有 3 个函数为薄包装
- `chaxun_tupu_quanbu()` → 组装空 `TupuCanshu`，调用 `chaxun_tupu_hexin`
- `chaxun_tupu_biaoqianid(biaoqianid)` → 先查关联节点 ID 列表，设置 `zhongxin_biaoqianidlie`，调用核心
- `chaxun_tupu_leixingmingcheng(leixingmingcheng)` → 设置 `jiedian_tiaojian` 和 `bian_tiaojian`，调用核心
- 改写后确保 `jiekou_ribao.rs` 中 `tupu_quanbu / tupu_biaoqianid / tupu_leixingmingcheng` 三个 caozuo 行为不变

### 1.3 验证
- 编译通过
- 手动测试三个现有图谱操作返回与改前一致

---

## 阶段二：后端新增图谱接口 ✅
> 目标：补齐"搜索定位 + 节点→日报 + 边→日报 + 多标签交集 + 参数化子图"。

### 2.1 tupu_sousuo（节点搜索/定位）
- 文件：`shujucaozuo_ribao_biaoqian.rs` 新增函数
- SQL：按 `biaoqian.zhi LIKE '%关键词%'` 模糊匹配，可选 `biaoqianleixing.mingcheng = $x`
- LEFT JOIN `ribao_biaoqian` 统计 `ribao_zongshu` 和 `MAX(ribao.fabushijian) AS zuijin_fabushijian`
- 接口注册：`jiekou_ribao.rs` 新增 caozuo `tupu_sousuo`

### 2.2 tupu_ribao_fenye（节点 → 日报分页）
- 文件：`shujucaozuo_ribao_biaoqian.rs` 新增函数
- SQL：`ribao_biaoqian rb JOIN ribao r ON rb.ribaoid = r.id LEFT JOIN yonghu y ON r.yonghuid = y.id WHERE rb.biaoqianid = $1 [AND r.fabushijian BETWEEN ...] ORDER BY r.fabushijian DESC LIMIT/OFFSET`
- 返回字段包含 `zhaiyao, kuozhan`（前端判断是否有导图/关系）
- 同步新增 `tongji_tupu_ribao_zongshu` 用于分页总数
- 接口注册：`jiekou_ribao.rs` 新增 caozuo `tupu_ribao_fenye`

### 2.3 tupu_bian_ribao_fenye（边 → 日报分页）
- 文件：`shujucaozuo_ribao_biaoqian.rs` 新增函数
- SQL：`ribao_biaoqian rb1 JOIN ribao_biaoqian rb2 ON rb1.ribaoid = rb2.ribaoid JOIN ribao r ON ... WHERE rb1.biaoqianid = $yuan AND rb2.biaoqianid = $mubiao`
- 接口注册：`jiekou_ribao.rs` 新增 caozuo `tupu_bian_ribao_fenye`

### 2.4 tupu_ribao_duobiaoqian_fenye（多标签交集）
- SQL：动态 `JOIN ribao_biaoqian` N 次（或用 `HAVING COUNT(DISTINCT biaoqianid) = N` 方案）
- 接口注册：`jiekou_ribao.rs` 新增 caozuo `tupu_ribao_duobiaoqian_fenye`

### 2.5 tupu_zitu（参数化子图查询）
- 基于阶段一的 `chaxun_tupu_hexin`，扩展参数：
  - `shendu`（1 或 2 层关联）
  - `leixingmingchenglie`（类型白名单）
  - `min_quanzhong`（过滤弱边）
  - `riqi_from / riqi_to`（时间过滤）
  - `zuida_jiedian / zuida_bian`（防爆）
- 接口注册：`jiekou_ribao.rs` 新增 caozuo `tupu_zitu`

### 2.6 验证
- 编译通过
- 对每个新接口手动测试

---

## 阶段三：前端图谱加载逻辑去重 ✅
> 目标：合并重复的加载/渲染入口，为后续新交互打基础。

### 3.1 合并图谱加载函数
- 文件：`wasm_sdk/ribao_jiemian.js`
- 将 `_tupu_jiazai(leixingmingcheng)` 和 `_tupu_jiazai_biaoqianid(biaoqianid)` 合并为：
  - `_tupu_jiazai_impl({ leixingmingcheng?, biaoqianid?, zhongxinid? })`
- 内部统一处理：加载态、错误态、解构响应、调用 `_tupu_xuanran`
- 原函数保留为薄包装调用 `_tupu_jiazai_impl`

### 3.2 逻辑层补齐新方法
- 文件：`wasm_sdk/ribao_luoji.js`
- 新增：`tupu_sousuo(guanjianci, leixingmingcheng)`、`tupu_ribao_fenye(biaoqianid, yeshu, meiyetiaoshu)`、`tupu_bian_ribao_fenye(yuan, mubiao, yeshu, meiyetiaoshu)`、`tupu_ribao_duobiaoqian_fenye(biaoqianidlie, yeshu, meiyetiaoshu)`

### 3.3 验证
- 现有图谱视图行为不变

---

## 阶段四：前端图谱交互增强 — 搜索 + 侧栏 + 日报联动 ✅
> 目标：实现"能定位 + 能追溯日报 + 能打开导图/关系"。

### 4.1 搜索框
- 图谱视图顶部工具条新增搜索输入框 + 类型下拉
- 搜索后调用 `tupu_sousuo`，在画布下方展示搜索结果列表
- 点击搜索结果项 → 调用 `_tupu_jiazai_impl({ biaoqianid, zhongxinid })` 以该节点为中心加载子图

### 4.2 右侧详情侧栏（核心新增 UI）
- 在 `tupu_rongqi` 右侧新增 `tupu_celandiv`（初始隐藏）
- 点击节点 → 打开侧栏，显示：
  - 节点信息（类型、值）
  - 调用 `tupu_ribao_fenye` 分页展示相关日报
  - 每条日报显示：`id / 发布者 / 时间 / 摘要`
  - 按钮：`查看原文`、`导图`（有 siweidaotu 时显示）、`关系`（有 guanxifenxi 时显示）
- 点击边 → 打开侧栏，显示：
  - 两端节点名称 + 共现次数
  - 调用 `tupu_bian_ribao_fenye` 分页展示共现日报
  - 同上显示日报项和按钮

### 4.3 导图/关系联动
- 侧栏日报项的"导图"按钮：
  - 若 `kuozhan` 已在列表数据中 → 解析后直接调用 `siweidaotu()` 打开弹窗
  - 否则先 `ribao_chaxun_id` 获取完整数据，再打开
- "关系"按钮同理，调用 `guanxifenxi()`

### 4.4 画布交互改进
- 单击节点：选中高亮 + 打开侧栏（替代当前仅显示底部 tooltip）
- 双击节点：以此为中心重新加载子图
- 单击边：高亮边 + 打开边详情侧栏
- 拖拽/缩放/平移行为保持不变

### 4.5 验证
- 搜索 → 定位 → 子图 → 侧栏 → 日报列表 → 导图/关系弹窗 完整链路走通

---

## 阶段五：前端图谱过滤器
> 目标：让图谱更清晰、噪声更少。

### 5.1 类型开关（chip/checkbox）
- 在图谱工具条展示所有类型 chip（来自 `leixing_chaxun_quanbu`）
- 勾选/取消后，前端过滤掉对应类型的节点和边，重新渲染
- 或走后端 `tupu_zitu` 的 `leixingmingchenglie` 参数

### 5.2 最小权重滑块
- 工具条添加滑块，拖动后过滤 `quanzhong < min_quanzhong` 的边
- 前端本地过滤即可（边数据已包含 quanzhong）

### 5.3 时间范围选择器
- 两个 date input（起止）
- 走后端 `tupu_zitu` 的 `riqi_from / riqi_to` 参数

### 5.4 验证
- 各过滤器组合使用，图谱节点/边数量随过滤变化

---

## 阶段六：性能与索引
> 目标：确保数据量增长后图谱查询不卡。

### 6.1 数据库索引检查与补充
- 确认 `ribao_biaoqian(biaoqianid)` 索引存在
- 确认 `ribao_biaoqian(ribaoid)` 索引存在
- 确认 `ribao(fabushijian)` 索引存在
- 不存在则补建

### 6.2 返回量防爆
- `tupu_zitu` 和 `chaxun_tupu_hexin` 内部加 `zuida_jiedian / zuida_bian` 上限（默认 500 / 2000）
- 前端节点超过阈值时提示"数据量较大，建议使用过滤器"

### 6.3 验证
- EXPLAIN 确认关键 SQL 走索引

---

## 阶段七：AI 关系分析融入图谱 ✅
> 目标：将日报 AI 提取的人物关系（kuozhan.guanxifenxi）作为**关系边**叠加到共现图谱中，
> 使图谱同时展示"标签共现"和"AI 识别关系"两个维度。

### 现状
- 每篇日报经 AI 任务处理后，`ribao.kuozhan` 的 JSON 中可能包含：
  ```json
  {"guanxifenxi": {"guanxi": [
    {"ren1": "林哲", "guanxi": "合作伙伴", "ren2": "黄伟", "miaoshu": "..."}
  ]}}
  ```
- 关系中的人名（ren1 / ren2）对应已有标签节点的 `biaoqian.zhi`
- 目前关系仅在单条日报的弹窗（`guanxifenxi()` 方法）中展示，未体现在全局图谱

### 7.1 后端：提取关系边
- 文件：`shujucaozuo_ribao_biaoqian.rs`
- 新增函数 `chaxun_tupu_guanxi_bian(jiedianlie: &[Value]) -> Vec<Value>`
  - 输入：当前图谱的节点列表（已包含 id 和 zhi）
  - 构建 name→id 映射：`HashMap<String, String>` 从 jiedianlie 的 zhi→id
  - SQL 查询：`SELECT id, kuozhan FROM ribao WHERE kuozhan IS NOT NULL AND kuozhan != ''`
  - 在 Rust 中遍历每条记录：
    1. 解析 kuozhan JSON
    2. 提取 `guanxifenxi.guanxi` 数组
    3. 对每组关系，通过 name 映射查找 ren1→yuan_id, ren2→mubiao_id
    4. 找到匹配的则收集 `(yuan_id, mubiao_id, guanxi, miaoshu, ribaoid)`
  - 按 `(yuan, mubiao, guanxi)` 聚合，统计 cishu（出现次数），合并 miaoshu 列表
  - 返回格式：`[{"yuan": id, "mubiao": id, "guanxi": "合作伙伴", "miaoshu": "...", "cishu": "3"}]`

### 7.2 后端：图谱响应加入关系边
- 修改 `chaxun_tupu_quanbu()`：
  ```
  let jiedian = ...;
  let bian = ...;
  let guanxi_bian = chaxun_tupu_guanxi_bian(&jiedian).await;
  json!({"jiedian": jiedian, "bian": bian, "guanxi_bian": guanxi_bian})
  ```
- 同理修改 `chaxun_tupu_biaoqianid()` 和 `chaxun_tupu_leixingmingcheng()`
- 编译验证

### 7.3 前端逻辑层
- 文件：`ribao_luoji.js`
- 现有 `tupu_chaxun_*` 方法无需修改（响应自动携带 guanxi_bian 字段）

### 7.4 前端图谱渲染：关系边
- 文件：`ribao_jiemian.js` 的 `_tupu_xuanran` 方法
- 数据解构时同时读取 `guanxi_bian`：
  ```js
  const { jiedian: jiedianlie, bian: bianlie } = jg.shuju;
  const guanxi_bianlie = jg.shuju.guanxi_bian || [];
  ```
  并传入 `_tupu_xuanran(rongqi, jiedianlie, bianlie, guanxi_bianlie, biaoqianid)`
- 在 `_tupu_xuanran` 中构建第二组边数组 `guanxi_bian`：
  ```js
  const guanxi_bian = guanxi_bianlie
    .filter(b => (String(b.yuan) in idmap) && (String(b.mubiao) in idmap))
    .map(b => ({yuan: idmap[...], mubiao: idmap[...], guanxi: b.guanxi, miaoshu: b.miaoshu, cishu: parseInt(b.cishu)||1}));
  ```
- `huizhi()` 函数中，在绘制共现边之后、绘制节点之前，新增关系边绘制循环：
  - 线型：**虚线**（`ctx.setLineDash([6, 4])`），区别于共现边的实线
  - 颜色：使用暖色调渐变（如 `#8B5CF6`→`#EC4899`，紫→粉），与冷色共现边形成对比
  - 线宽：`1.5 + cishu * 0.3`
  - 曲线弧度比共现边更大（`curv = Math.min(30, elen * 0.06)`），视觉上更明显地弯曲
  - 边中点绘制关系标签文字（如"合作伙伴"）：
    - 小号字体（10px），半透明背景胶囊
    - 仅在 `suofang >= 0.6` 时显示
  - 高亮逻辑：hover/选中时加粗 + 提高不透明度
- `ctx.setLineDash([])` 恢复实线，然后继续画节点

### 7.5 前端交互：关系边点击/hover
- `zhaobiaobian()` 函数扩展为同时检测关系边的距离（或新增 `zhaoguanxibian()` 函数）
- `onmousemove`：hover 关系边时，底部提示框显示 `ren1 — 关系类型 — ren2 (N篇日报提及)`
- `onmouseup`（单击空白→边检测）：点击关系边时，打开侧栏显示：
  - 关系类型 + 描述
  - 两端节点信息
  - 关联日报列表（复用 `tupu_bian_ribao_fenye` 或新增按 kuozhan 搜索）

### 7.6 图例更新
- 在图谱图例（tuli）中追加一项：`── 共现关系` + `╌╌ AI识别关系`
- 用线型 + 颜色区分

### 7.7 验证
- 编译通过
- 图谱中同时显示实线共现边 + 虚线关系边
- hover 关系边显示关系信息
- 点击关系边打开侧栏
- 不同类型关系（同事、客户、合作伙伴等）可辨识

---

## 阶段八：图谱全屏功能 ✅
> 目标：支持图谱画布全屏查看，提升大规模图谱浏览体验。

### 8.1 工具栏全屏按钮
- 在工具栏“重置”按钮后新增 `⛶` 全屏按钮（32×32px，与其他按钮风格一致）
- 点击切换 `rongqi.requestFullscreen()` / `document.exitFullscreen()`

### 8.2 动态尺寸调整
- `kuan`/`gao`/`shijiezhongxin_x`/`shijiezhongxin_y` 改为 `let`，支持动态更新
- 监听 `fullscreenchange` 事件，全屏时设为 `window.innerWidth/Height`，退出时恢复原始计算
- 同步更新 `canvas.width/height` 和世界中心点
- 按钮 title 随状态切换（“全屏”/“退出全屏”）

### 8.3 事件清理
- `_tupu_tingzhi` 回调中追加 `document.removeEventListener('fullscreenchange', ...)`，防止内存泄漏

---

## 阶段九：AI 标签多值拆分 ✅
> 目标：解决 AI 提取标签时将多个人名用逗号拼接为一个值的问题，使每个人名作为独立标签。

### 问题分析

**现象**：AI 提取“我方人员”“对方人员”等标签时，多个人名被合并为一个值，如 `"我方人员": "张三,李四,王五"`，而不是拆分为三个独立标签。

**根因（两层）**：

1. **Prompt 格式限制**：`ai_tiqu_biaoqian()` 要求 AI 返回 `{"标签名1": "值1", "标签名2": "值2"}`。
  JSON 对象的 key 必须唯一，所以同一类型（如“我方人员”）只能有一个值，AI 被迫用逗号拼接多人名。
  - 文件：`gongju_ribaorenwuchuli.rs` 第 233-241 行

2. **解析未拆分**：`tichubiaoqianxiang()` 解析 JSON 时，直接将值作为整体使用，未对逗号/顿号等分隔符做拆分。
  - 文件：`gongju_ribaorenwuchuli.rs` 第 296-307 行

### 解决方案

#### 9.1 Prompt 调整：支持数组值
- 修改 `ai_tiqu_biaoqian()` 的系统提示词，告知 AI 多值标签使用数组：
  ```
  返回JSON格式：{"xxx": "yyy", ...}
  如果某个标签有多个值（如多个人名），使用数组：{"xxx": ["aaa", "bbb"]}
  ```

#### 9.2 配置扩展：标记多值标签
- `Ribaobiaoqian` 结构体新增 `duozhi: bool` 字段（默认 false）
- `peizhi/ai.json` 中“我方人员”“对方人员”“客户名字”等人名类标签设置 `"duozhi": true`
- Prompt 构建时，对 `duozhi=true` 的标签追加提示 `【多值，用数组】`

#### 9.3 后端解析增强：拆分多值
- 修改 `tichubiaoqianxiang()` 的 JSON 解析分支（第 289-311 行）：
  - 当值为 JSON 数组时：遍历数组，每个元素创建独立标签
  - 当值为字符串且含分隔符（`,`、`，`、`、`）时：拆分为多条独立标签
  - 拆分后每个值 trim 去空白，跳过空值
- 参考伪代码：
  ```rust
  // JSON 对象解析分支内
  match &zhi {
      Value::Array(shuzu) => {
          for xiang in shuzu {
              if let Some(wenzi) = xiang.as_str().map(|s| s.trim().to_string()) {
                  // 插入独立标签 (biaozhun, wenzi)
              }
          }
      }
      Value::String(s) => {
          // 分隔符拆分 + trim
          for pian in s.split(&[',', '，', '、'][..]) { ... }
      }
      _ => { /* 数字等其他类型，保持原逻辑 */ }
  }
  ```

#### 9.4 影响范围
- 改动文件：
  - `src/peizhixt/peizhi_nr/peizhi_ai.rs` — Ribaobiaoqian 加 duozhi 字段
  - `peizhi/ai.json` — 人名类标签加 duozhi:true
  - `src/gongju/ai/openai/gongjuji/ribao/gongju_ribaorenwuchuli.rs` — prompt + 解析
- 已有标签数据影响：新提取的日报会正确拆分；已存在的“张三,李四”样式标签需决定是否批量清理

---

## 阶段十：公司关系分析 + 数据清理重置 ✅
> 目标：AI 关系分析覆盖公司间关系；清理历史 AI 生成数据，回归原始日报。

### 10.1 关系分析 Prompt 扩展
- 修改 `guanxifenxi_tishici`（`peizhi/ai.json` + `peizhi_ai.rs` 默认值）：
  - 同时分析人物关系和公司关系，统一放入 `guanxi` 数组
  - `ren1/ren2` 可以是人名或公司名
  - 新增公司关系类型：合作方、竞争对手、上下游、客户供应商、子母公司等
  - 因公司名匹配图谱节点的逻辑与人名相同（通过 `biaoqian.zhi` 映射），后端无需额外改动

### 10.2 配置补充
- `客户公司` 标签设置 `duozhi: true`（一篇日报可能涉及多个公司）

### 10.3 数据库清理
- 直连数据库执行以下操作：
  ```sql
  UPDATE ribao SET zhaiyao = NULL, kuozhan = NULL;  -- 清除摘要、思维导图、关系分析
  DELETE FROM ribao_biaoqian;     -- 清除标签关联
  DELETE FROM ribao_biaoqianrenwu; -- 清除任务队列
  DELETE FROM biaoqian;            -- 清除标签
  DELETE FROM biaoqianleixing;     -- 清除标签类型
  ```
- 结果：7 篇日报保留原始 neirong，其余 AI 生成数据全部清空
- 重新跑任务即可用新配置重新生成

---

## 阶段十一：修复“无关联”关系类型 + 数据清理 ✅
> 目标：AI 关系分析不再返回“无关联”等无意义关系类型，后端兼做兑底过滤。

### 问题分析
- AI 关系分析时，对找不到明确关系的实体对仍然返回了 `{"ren1": "X", "ren2": "Y", "guanxi": "无关联"}`
- 后端 `chaxun_tupu_guanxi_bian()` 未过滤，导致图谱中出现“无关联”类型的边

### 11.1 Prompt 修复
- 文件：`peizhi/ai.json` + `src/peizhixt/peizhi_nr/peizhi_ai.rs`
- `guanxifenxi_tishici` 新增第 7 条注意事项：
  - “如果两个实体之间没有关系，不要返回该条目，禁止使用“无关联”“无关系”“无”等作为关系类型”

### 11.2 后端兑底过滤
- 文件：`shujucaozuo_ribao_biaoqian.rs` 的 `chaxun_tupu_guanxi_bian()` 函数
- 解析 `guanxi` 字段后新增过滤逻辑：
  ```rust
  if guanxi.is_empty() || guanxi.contains("无关") || guanxi == "无" {
      continue;
  }
  ```
- 匹配策略：`contains("无关")` 子串匹配，覆盖“无关联”“无关系”等变体，不会误杀合法关系类型

### 11.3 数据库清理重置
- 清除历史 AI 生成数据，使新 Prompt 生效：
  ```sql
  UPDATE ribao SET zhaiyao = NULL, kuozhan = NULL;
  DELETE FROM ribao_biaoqian;
  DELETE FROM ribao_biaoqianrenwu;
  DELETE FROM biaoqian;
  DELETE FROM biaoqianleixing;
  ```

---

## 阶段十二：图谱关系边显示 AI 理由 ✅
> 目标：在图谱中直观展示 AI 分析关系的理由（miaoshu），而不仅仅是关系类型。

### 现状
- 后端 `guanxi_bian` 已包含 `miaoshu` 字段（AI 分析关系的说明文本）
- 前端 `guanxi_bian` 数组已携带 `miaoshu`（`ribao_jiemian.js:1280`）
- 但仅在点击关系边打开侧栏时才显示 miaoshu（`_tupu_xianshi_celan_guanxibian`）
- 图谱画布上的边标签只显示关系类型（如“同事”），hover 提示框也不包含理由

### 12.1 画布边标签增加副标题
- 文件：`wasm_sdk/ribao_jiemian.js` 的 `huizhi()` 函数内关系边绘制循环
- 当 `suofang >= 0.85` 且 `gb.miaoshu` 非空时，在关系类型下方显示截断的 miaoshu 副标题：
  - 取 miaoshu 第一段（以“；”分割），截断至 15 字 + “…”
  - 字体比主标签小 18%（`lfs * 0.82`），使用浅灰色
  - 胶囊背景自动扩展以容纳两行文字

### 12.2 Hover 提示框显示完整理由
- 底部 `xinxi` 提示框（`tupu_xinxi`）：
  - 设置 `max-width:520px; line-height:1.6` 支持多行
  - hover 关系边时，第二行显示完整 miaoshu（小字号、灰色）

### 12.3 侧栏已有支持
- `_tupu_xianshi_celan_guanxibian()` 已在关系详情卡片中显示完整 miaoshu，无需修改
