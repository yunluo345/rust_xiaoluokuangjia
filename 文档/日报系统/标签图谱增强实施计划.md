# 标签共现图谱增强 — 实施计划

## 阶段一：后端图谱查询去重重构
> 目标：消除 3 个图谱函数的重复 SQL，为后续新接口打好基础。

### 1.1 抽取核心图谱查询函数
- 文件：`src/shujuku/psqlshujuku/shujubiao_nr/ribao/shujucaozuo_ribao_biaoqian.rs`
- 定义 `TupuCanshu` 结构体：
  - `jiedian_tiaojian: Option<String>`（节点 WHERE 子句片段）
  - `jiedian_canshu: Vec<String>`（节点查询参数）
  - `bian_tiaojian: Option<String>`（边额外 WHERE 子句片段）
  - `bian_canshu: Vec<String>`（边查询参数）
  - `zhongxin_biaoqianidlie: Option<Vec<String>>`（子图模式：限定边的节点范围）
- 实现 `chaxun_tupu_hexin(canshu: &TupuCanshu) -> Option<Value>`，内部统一组装：
  - 节点 SQL：`SELECT b.id, b.zhi, b.leixingid, l.mingcheng AS leixingmingcheng FROM biaoqian b JOIN biaoqianleixing l ON ... [WHERE ...]`
  - 边 SQL：自连接 + `GROUP BY` + 可选 `WHERE IN` / 类型过滤
  - 返回 `{"jiedian": [...], "bian": [...]}`

### 1.2 改写现有 3 个函数为薄包装
- `chaxun_tupu_quanbu()` → 组装空 `TupuCanshu`，调用 `chaxun_tupu_hexin`
- `chaxun_tupu_biaoqianid(biaoqianid)` → 先查关联节点 ID 列表，设置 `zhongxin_biaoqianidlie`，调用核心
- `chaxun_tupu_leixingmingcheng(leixingmingcheng)` → 设置 `jiedian_tiaojian` 和 `bian_tiaojian`，调用核心
- 改写后确保 `jiekou_ribao.rs` 中 `tupu_quanbu / tupu_biaoqianid / tupu_leixingmingcheng` 三个 caozuo 行为不变

### 1.3 验证
- 编译通过
- 手动测试三个现有图谱操作返回与改前一致

---

## 阶段二：后端新增图谱接口
> 目标：补齐"搜索定位 + 节点→日报 + 边→日报 + 多标签交集 + 参数化子图"。

### 2.1 tupu_sousuo（节点搜索/定位）
- 文件：`shujucaozuo_ribao_biaoqian.rs` 新增函数
- SQL：按 `biaoqian.zhi LIKE '%关键词%'` 模糊匹配，可选 `biaoqianleixing.mingcheng = $x`
- LEFT JOIN `ribao_biaoqian` 统计 `ribao_zongshu` 和 `MAX(ribao.fabushijian) AS zuijin_fabushijian`
- 接口注册：`jiekou_ribao.rs` 新增 caozuo `tupu_sousuo`

### 2.2 tupu_ribao_fenye（节点 → 日报分页）
- 文件：`shujucaozuo_ribao_biaoqian.rs` 新增函数
- SQL：`ribao_biaoqian rb JOIN ribao r ON rb.ribaoid = r.id LEFT JOIN yonghu y ON r.yonghuid = y.id WHERE rb.biaoqianid = $1 [AND r.fabushijian BETWEEN ...] ORDER BY r.fabushijian DESC LIMIT/OFFSET`
- 返回字段包含 `zhaiyao, kuozhan`（前端判断是否有导图/关系）
- 同步新增 `tongji_tupu_ribao_zongshu` 用于分页总数
- 接口注册：`jiekou_ribao.rs` 新增 caozuo `tupu_ribao_fenye`

### 2.3 tupu_bian_ribao_fenye（边 → 日报分页）
- 文件：`shujucaozuo_ribao_biaoqian.rs` 新增函数
- SQL：`ribao_biaoqian rb1 JOIN ribao_biaoqian rb2 ON rb1.ribaoid = rb2.ribaoid JOIN ribao r ON ... WHERE rb1.biaoqianid = $yuan AND rb2.biaoqianid = $mubiao`
- 接口注册：`jiekou_ribao.rs` 新增 caozuo `tupu_bian_ribao_fenye`

### 2.4 tupu_ribao_duobiaoqian_fenye（多标签交集）
- SQL：动态 `JOIN ribao_biaoqian` N 次（或用 `HAVING COUNT(DISTINCT biaoqianid) = N` 方案）
- 接口注册：`jiekou_ribao.rs` 新增 caozuo `tupu_ribao_duobiaoqian_fenye`

### 2.5 tupu_zitu（参数化子图查询）
- 基于阶段一的 `chaxun_tupu_hexin`，扩展参数：
  - `shendu`（1 或 2 层关联）
  - `leixingmingchenglie`（类型白名单）
  - `min_quanzhong`（过滤弱边）
  - `riqi_from / riqi_to`（时间过滤）
  - `zuida_jiedian / zuida_bian`（防爆）
- 接口注册：`jiekou_ribao.rs` 新增 caozuo `tupu_zitu`

### 2.6 验证
- 编译通过
- 对每个新接口手动测试

---

## 阶段三：前端图谱加载逻辑去重
> 目标：合并重复的加载/渲染入口，为后续新交互打基础。

### 3.1 合并图谱加载函数
- 文件：`wasm_sdk/ribao_jiemian.js`
- 将 `_tupu_jiazai(leixingmingcheng)` 和 `_tupu_jiazai_biaoqianid(biaoqianid)` 合并为：
  - `_tupu_jiazai_impl({ leixingmingcheng?, biaoqianid?, zhongxinid? })`
- 内部统一处理：加载态、错误态、解构响应、调用 `_tupu_xuanran`
- 原函数保留为薄包装调用 `_tupu_jiazai_impl`

### 3.2 逻辑层补齐新方法
- 文件：`wasm_sdk/ribao_luoji.js`
- 新增：`tupu_sousuo(guanjianci, leixingmingcheng)`、`tupu_ribao_fenye(biaoqianid, yeshu, meiyetiaoshu)`、`tupu_bian_ribao_fenye(yuan, mubiao, yeshu, meiyetiaoshu)`、`tupu_ribao_duobiaoqian_fenye(biaoqianidlie, yeshu, meiyetiaoshu)`

### 3.3 验证
- 现有图谱视图行为不变

---

## 阶段四：前端图谱交互增强 — 搜索 + 侧栏 + 日报联动
> 目标：实现"能定位 + 能追溯日报 + 能打开导图/关系"。

### 4.1 搜索框
- 图谱视图顶部工具条新增搜索输入框 + 类型下拉
- 搜索后调用 `tupu_sousuo`，在画布下方展示搜索结果列表
- 点击搜索结果项 → 调用 `_tupu_jiazai_impl({ biaoqianid, zhongxinid })` 以该节点为中心加载子图

### 4.2 右侧详情侧栏（核心新增 UI）
- 在 `tupu_rongqi` 右侧新增 `tupu_celandiv`（初始隐藏）
- 点击节点 → 打开侧栏，显示：
  - 节点信息（类型、值）
  - 调用 `tupu_ribao_fenye` 分页展示相关日报
  - 每条日报显示：`id / 发布者 / 时间 / 摘要`
  - 按钮：`查看原文`、`导图`（有 siweidaotu 时显示）、`关系`（有 guanxifenxi 时显示）
- 点击边 → 打开侧栏，显示：
  - 两端节点名称 + 共现次数
  - 调用 `tupu_bian_ribao_fenye` 分页展示共现日报
  - 同上显示日报项和按钮

### 4.3 导图/关系联动
- 侧栏日报项的"导图"按钮：
  - 若 `kuozhan` 已在列表数据中 → 解析后直接调用 `siweidaotu()` 打开弹窗
  - 否则先 `ribao_chaxun_id` 获取完整数据，再打开
- "关系"按钮同理，调用 `guanxifenxi()`

### 4.4 画布交互改进
- 单击节点：选中高亮 + 打开侧栏（替代当前仅显示底部 tooltip）
- 双击节点：以此为中心重新加载子图
- 单击边：高亮边 + 打开边详情侧栏
- 拖拽/缩放/平移行为保持不变

### 4.5 验证
- 搜索 → 定位 → 子图 → 侧栏 → 日报列表 → 导图/关系弹窗 完整链路走通

---

## 阶段五：前端图谱过滤器
> 目标：让图谱更清晰、噪声更少。

### 5.1 类型开关（chip/checkbox）
- 在图谱工具条展示所有类型 chip（来自 `leixing_chaxun_quanbu`）
- 勾选/取消后，前端过滤掉对应类型的节点和边，重新渲染
- 或走后端 `tupu_zitu` 的 `leixingmingchenglie` 参数

### 5.2 最小权重滑块
- 工具条添加滑块，拖动后过滤 `quanzhong < min_quanzhong` 的边
- 前端本地过滤即可（边数据已包含 quanzhong）

### 5.3 时间范围选择器
- 两个 date input（起止）
- 走后端 `tupu_zitu` 的 `riqi_from / riqi_to` 参数

### 5.4 验证
- 各过滤器组合使用，图谱节点/边数量随过滤变化

---

## 阶段六：性能与索引
> 目标：确保数据量增长后图谱查询不卡。

### 6.1 数据库索引检查与补充
- 确认 `ribao_biaoqian(biaoqianid)` 索引存在
- 确认 `ribao_biaoqian(ribaoid)` 索引存在
- 确认 `ribao(fabushijian)` 索引存在
- 不存在则补建

### 6.2 返回量防爆
- `tupu_zitu` 和 `chaxun_tupu_hexin` 内部加 `zuida_jiedian / zuida_bian` 上限（默认 500 / 2000）
- 前端节点超过阈值时提示"数据量较大，建议使用过滤器"

### 6.3 验证
- EXPLAIN 确认关键 SQL 走索引
