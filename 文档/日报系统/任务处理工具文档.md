# 任务处理工具文档

## 文件位置
`src/gongju/ai/openai/gongjuji/ribao/gongju_ribaorenwuchuli.rs`

## 目的
该工具负责 **后台处理已通过 `gongju_ribaojiancha` 审核的日报**，把结构化的日报数据保存到数据库，并为每条日报创建对应的 **任务**（如后续审批、提醒等）。

## 调用入口
- 通过 AI 工具分发器执行：`zhixing(canshu: &str, lingpai: &str) -> String`
- **执行规则**：只在 **具备管理权限** 的用户下可使用。
- **权限路径**：`/jiekou/ribao/guanli`（由 `yonghuyanzheng::yanzhenglingpaijiquanxian` 校验）。

## 工作流程

| 步骤 | 说明 |
|------|------|
| **1. 权限校验** | 调用 `yanzhenglingpaijiquanxian`，确保用户具备 `/jiekou/ribao/guanli` 接口的操作权限。 |
| **2. 参数解析** | 解析输入 JSON，提取日报内容（`neirong` 或 `ribaoneirong`）及可选的发布时间。 |
| **3. 配置读取** | 从 `Ai` 配置文件中读取日报标签定义、必填项、泛指词等规则。 |
| **4. 标签提取** | 调用 AI (OpenAI/Grok) 从正文中提取预定义的结构化标签。若 AI 失败，回退至关键词正则提取。 |
| **5. 数据合法性检查** | 检查提取出的必填项是否为空，并过滤定义的“泛指词”（如“客户方”、“无”等）。 |
| **6. 数据持久化** | 将审核后的日报原文和结构化数据保存至数据库，获取 `ribaoid`。 |
| **7. 任务发布** | 根据配置的重试次数，向后台任务队列发布标签处理任务，获取 `renwuid`。 |
| **8. 结果返回** | 向 AI 提供包含成功状态、提取到的数据和 ID 的 JSON 结果，由 AI 组织回复。 |

## 关键技术点

- **双重提取机制**：AI 提取保证灵活性，正则提取保证在网络或 AI 异常时的可靠兜底。
- **泛指词过滤**：防止用户用模糊词语规避关键字段的填报（如姓名填“负责人”）。
- **统一验证**：与系统中间件授权逻辑一致，确保安全性。

## 配置依赖
由 `src/peizhixt/peizhi_nr/peizhi_ai.rs` 下的 `Ai` 结构体进行配置。
- `ribao_biaoqian`: 定义标签、属性及是否必填。
- `ribao_biaoqianrenwu_chongshi_cishu`: 任务发布的重试次数。
