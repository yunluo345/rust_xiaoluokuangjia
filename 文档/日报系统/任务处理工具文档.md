# 任务处理工具文档

## 文件位置
`src/gongju/ai/openai/gongjuji/ribao/gongju_ribaorenwuchuli.rs`
`src/gongju/ai/openai/gongjuji/ribao/gongju_ribaotijiao.rs`

## 目的
该工具负责 **后台处理已通过 `gongju_ribaojiancha` 审核的日报**，把结构化的日报数据保存到数据库，并为每条日报创建对应的 **任务**（如后续审批、提醒等）。

## 统一提交与自动触发（任意途径）

系统已统一日报提交编排：**日报落库 → 发布任务 → 异步尝试启动调度器**。

覆盖入口：
- 普通用户接口：`/jiekou/ribao/yonghu` 的 `xinzeng`
- 管理员接口：`/jiekou/ribao/guanli` 的 `ribao_xinzeng`
- AI 工具：`ribao_jiancha`

统一入口模块：`gongju_ribaotijiao::tijiao_ribao_bingzidongqidong`

## 调用入口
- 通过 AI 工具分发器执行：`zhixing(canshu: &str, lingpai: &str) -> String`
- **执行规则**：只在 **具备管理权限** 的用户下可使用。
- **权限路径**：`/jiekou/ribao/guanli`（由 `yonghuyanzheng::yanzhenglingpaijiquanxian` 校验）。

## 工作流程

| 步骤 | 说明 |
|------|------|
| **1. 权限校验** | 调用 `yanzhenglingpaijiquanxian`，确保用户具备 `/jiekou/ribao/guanli` 接口的操作权限。 |
| **2. 参数解析** | 解析输入 JSON，提取日报内容（`neirong` 或 `ribaoneirong`）及可选的发布时间。 |
| **3. 配置读取** | 从 `Ai` 配置文件中读取日报标签定义、必填项、泛指词等规则。 |
| **4. 标签提取** | 调用 AI (OpenAI/Grok) 从正文中提取预定义的结构化标签。若 AI 失败，回退至关键词正则提取。 |
| **5. 数据合法性检查** | 检查提取出的必填项是否为空，并过滤定义的“泛指词”（如“客户方”、“无”等）。 |
| **6. 数据持久化** | 将审核后的日报原文和结构化数据保存至数据库，获取 `ribaoid`。 |
| **7. 任务发布** | 根据配置的重试次数，向后台任务队列发布标签处理任务，获取 `renwuid`。 |
| **8. 结果返回** | 向 AI 提供包含成功状态、提取到的数据和 ID 的 JSON 结果，由 AI 组织回复。 |

## 关键技术点

- **双重提取机制**：AI 提取保证灵活性，正则提取保证在网络或 AI 异常时的可靠兜底。
- **泛指词过滤**：防止用户用模糊词语规避关键字段的填报（如姓名填“负责人”）。
- **统一验证**：与系统中间件授权逻辑一致，确保安全性。

## 配置依赖
由 `src/peizhixt/peizhi_nr/peizhi_ai.rs` 下的 `Ai` 结构体进行配置。
- `ribao_biaoqian`: 定义标签、属性及是否必填。
- `ribao_biaoqianrenwu_chongshi_cishu`: 任务发布的重试次数。

## 并发与冲突说明（任务运行中再次提交）

结论：**支持**。在“任务处理正在运行”时再次提交日报，不会产生任务执行冲突。

### 1) 调度器单实例互斥（进程内）
- 调度器启动使用原子位 `compare_exchange(false -> true)`。
- 若调度器已在运行，再次启动会直接返回“已在运行中”，不会并发启动第二个调度循环。

### 2) 任务入队幂等（按日报去重）
- 任务发布使用 `INSERT ... ON CONFLICT (ribaoid) DO UPDATE`。
- 同一日报重复发布不会生成重复任务，而是重置为待处理状态（可重试）。

### 3) 任务领取防重复
- 任务领取使用 `FOR UPDATE SKIP LOCKED`。
- 即使出现并发领取，也不会让同一任务被多个处理器同时处理。

### 4) 运行中再次提交时的实际行为
- 新提交日报会先落库，再创建/更新对应任务为待处理。
- 如果调度器正在运行：新任务会在后续轮次被继续领取处理。
- 如果调度器刚好停止：下一次“提交后触发调度”会再次拉起处理，不会丢任务。

### 5) 边界说明
- 以上“单实例互斥”是**进程内**保证；多实例部署时会有多个调度器实例同时运行。
- 多实例场景下仍依赖数据库行锁（`SKIP LOCKED`）避免同一任务被重复消费。

## 重新入队时的数据清空范围

当执行“重新入队”（`renwu_chongxin_ruidui` / `renwu_chongxin_ruidui_ribaoid`）时，系统会先清理该日报的 AI 产物，再重置任务状态：

- 删除该日报已绑定的标签关联（`ribao_biaoqian`）。
- 清空该日报的摘要字段（`zhaiyao = NULL`）。
- 清空该日报的扩展字段（`kuozhan = NULL`，包含思维导图、关系分析等扩展结果）。
- 重置任务为待处理（`zhuangtai='false'`、`changshicishu=0`、`biaoqianjieguo=NULL`）。

说明：日报原始正文（`neirong`）与发布时间（`fabushijian`）会保留，用于后续重新处理。
