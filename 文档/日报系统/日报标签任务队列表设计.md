# 日报标签任务队列表设计

## 队列表 (shujubiao_ribao_biaoqianrenwu)

用于存储“日报提交后由AI异步打标签”的排队任务。每条日报默认对应一条任务记录，任务处理结果可重试、可追踪。状态采用布尔语义：`false` 未处理，`true` 已处理。

| 字段名 | 中文名 | 说明 | 类型 | 默认值 |
| --- | --- | --- | --- | --- |
| `id` | 任务ID | 队列任务唯一标识 | `BIGSERIAL PRIMARY KEY` | 无 |
| `ribaoid` | 日报ID | 关联日报表 `ribao(id)` | `BIGINT NOT NULL` | 无 |
| `yonghuid` | 用户ID | 关联用户表 `yonghu(id)` | `BIGINT NOT NULL` | 无 |
| `zhuangtai` | 任务状态 | `false`=未处理，`true`=已处理 | `TEXT NOT NULL` | `false` |
| `changshicishu` | 已尝试次数 | 当前已执行次数 | `INT NOT NULL` | `0` |
| `zuidachangshicishu` | 最大尝试次数 | 达到后不再自动重试 | `INT NOT NULL` | `3` |
| `biaoqianjieguo` | 标签结果 | AI产出的标签结果JSON字符串 | `TEXT` | 无 |
| `chuangjianshijian` | 创建时间 | 记录创建时间 | `TEXT NOT NULL` | 无 |
| `gengxinshijian` | 更新时间 | 记录最后更新时间 | `TEXT NOT NULL` | 无 |

## 约束建议

- 外键：`FOREIGN KEY (ribaoid) REFERENCES ribao(id) ON DELETE CASCADE`
- 外键：`FOREIGN KEY (yonghuid) REFERENCES yonghu(id) ON DELETE CASCADE`
- 唯一：`UNIQUE (ribaoid)`，默认一条日报仅有一条当前任务
- 状态校验：`CHECK (zhuangtai IN ('true','false'))`
- 非负校验：`CHECK (changshicishu >= 0 AND zuidachangshicishu >= 0)`

## 索引建议

- `idx_ribao_biaoqianrenwu_zhuangtai_chuangjian(zhuangtai, chuangjianshijian)`：按最近时间拉取未处理任务（`zhuangtai='false'`）
- `idx_ribao_biaoqianrenwu_yonghuid(yonghuid)`：按用户排查任务
- `idx_ribao_biaoqianrenwu_gengxinshijian(gengxinshijian)`：任务巡检与清理

## 状态流转

- 新建任务：`false`（未处理）
- Worker领取：`true`（已处理，按 `chuangjianshijian` 降序，同时间随机）
- 执行成功：`true`
- 执行失败：`true`（失败只标记状态，是否可再次处理由重试次数判断）

## 与现有表关系

- `ribao_biaoqianrenwu.ribaoid -> ribao.id`
- `ribao_biaoqianrenwu.yonghuid -> yonghu.id`
- 队列按最近时间优先领取，同时间随机
- 删除用户或日报时，相关任务自动级联删除（`ON DELETE CASCADE`）
