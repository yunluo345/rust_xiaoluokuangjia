# 日报标签任务队列表设计

## 队列表 (shujubiao_ribao_biaoqianrenwu)

用于存储“日报提交后由AI异步打标签”的排队任务。每条日报默认对应一条任务记录，任务处理结果可重试、可追踪。

| 字段名 | 中文名 | 说明 | 类型 | 默认值 |
| --- | --- | --- | --- | --- |
| `id` | 任务ID | 队列任务唯一标识 | `BIGSERIAL PRIMARY KEY` | 无 |
| `ribaoid` | 日报ID | 关联日报表 `ribao(id)` | `BIGINT NOT NULL` | 无 |
| `yonghuid` | 用户ID | 关联用户表 `yonghu(id)` | `BIGINT NOT NULL` | 无 |
| `zhuangtai` | 任务状态 | `dengdai`/`zhixing`/`chenggong`/`shibai` | `TEXT NOT NULL` | `dengdai` |
| `youxianji` | 优先级 | 数值越小优先级越高 | `INT NOT NULL` | `100` |
| `changshicishu` | 已尝试次数 | 当前已执行次数 | `INT NOT NULL` | `0` |
| `zuidachangshicishu` | 最大尝试次数 | 达到后不再自动重试 | `INT NOT NULL` | `3` |
| `xiacizhixingshijian` | 下次执行时间 | 用于失败后延迟重试 | `TEXT` | 无 |
| `lingqushijian` | 领取时间 | Worker领取任务时间 | `TEXT` | 无 |
| `wanchengshijian` | 完成时间 | 成功或最终失败时间 | `TEXT` | 无 |
| `shibaiyuanyin` | 失败原因 | 最近一次失败错误信息 | `TEXT` | 无 |
| `biaoqianjieguo` | 标签结果 | AI产出的标签结果JSON字符串 | `TEXT` | 无 |
| `chuangjianshijian` | 创建时间 | 记录创建时间 | `TEXT NOT NULL` | 无 |
| `gengxinshijian` | 更新时间 | 记录最后更新时间 | `TEXT NOT NULL` | 无 |

## 约束建议

- 外键：`FOREIGN KEY (ribaoid) REFERENCES ribao(id) ON DELETE CASCADE`
- 外键：`FOREIGN KEY (yonghuid) REFERENCES yonghu(id) ON DELETE CASCADE`
- 唯一：`UNIQUE (ribaoid)`，默认一条日报仅有一条当前任务
- 状态校验：`CHECK (zhuangtai IN ('dengdai','zhixing','chenggong','shibai'))`
- 非负校验：`CHECK (changshicishu >= 0 AND zuidachangshicishu >= 0)`

## 索引建议

- `idx_ribao_biaoqianrenwu_zhuangtai_xiaci(zhuangtai, xiacizhixingshijian)`：拉取待执行任务
- `idx_ribao_biaoqianrenwu_yonghuid(yonghuid)`：按用户排查任务
- `idx_ribao_biaoqianrenwu_gengxinshijian(gengxinshijian)`：任务巡检与清理

## 状态流转

- 新建任务：`dengdai`
- Worker领取：`zhixing`
- 执行成功：`chenggong`
- 执行失败：`shibai`（若可重试则更新 `xiacizhixingshijian` 后回到 `dengdai`）

## 与现有表关系

- `ribao_biaoqianrenwu.ribaoid -> ribao.id`
- `ribao_biaoqianrenwu.yonghuid -> yonghu.id`
- 删除用户或日报时，相关任务自动级联删除（`ON DELETE CASCADE`）
