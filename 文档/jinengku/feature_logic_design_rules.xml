<?xml version="1.0" encoding="UTF-8"?>
<feature_logic_design_rules>

  <purpose>
    This XML defines the workflow for feature logic design (NOT UI design).
    It ensures the design is implementable and does not deviate from the existing project architecture,
    naming conventions, and code patterns.
  </purpose>

  <core_principles>
    <principle>Logic design only: flows, rules, states, data, APIs, permissions, edge cases.</principle>
    <principle>Fit the existing codebase: reuse patterns, modules, and utilities.</principle>
    <principle>Implementability first: every proposed idea must map to real code changes.</principle>
    <principle>Minimal disruption: avoid new frameworks, new layers, or large refactors.</principle>
    <principle>Show the thinking process to the user as a structured design explanation.</principle>
  </core_principles>

  <constraints>
    <constraint>Reply in the user's language.</constraint>
    <constraint>Do NOT run frontend/backend. User will test.</constraint>
    <constraint>No code output in the design phase.</constraint>
    <constraint>Do not introduce new conventions unless explicitly requested.</constraint>
    <constraint>Do not invent APIs/types/modules if existing ones can be reused.</constraint>
  </constraints>

  <workflow>

    <phase1_intent_clarification>
      <goal>Understand the requested feature and confirm scope.</goal>
      <actions>
        <action>Restate the feature requirement in simple words (1-3 sentences).</action>
        <action>Identify goal, non-goals, and success criteria.</action>
        <action>Ask for confirmation. If not confirmed, do not continue.</action>
      </actions>
      <output_required>
        <section_name>Feature Summary</section_name>
        <fields>
          <field>Goal</field>
          <field>Non-goals</field>
          <field>Success Criteria</field>
          <field>Assumptions (if any)</field>
          <field>Open Questions</field>
        </fields>
      </output_required>
      <rule>No code in this phase.</rule>
    </phase1_intent_clarification>

    <phase2_existing_architecture_alignment>
      <goal>Anchor the design to the existing architecture and patterns.</goal>
      <actions>
        <action>Read the relevant surrounding code and identify the current architecture style.</action>
        <action>Use Breezell index/search to find similar existing features and patterns.</action>
        <action>Identify reuse candidates: utilities, services, hooks, DTOs, validators, error handlers.</action>
        <action>List the files/modules most likely to be modified (without editing yet).</action>
      </actions>
      <output_required>
        <section_name>Architecture Fit</section_name>
        <fields>
          <field>Existing Pattern(s) to Follow</field>
          <field>Reuse Candidates</field>
          <field>Likely Touch Points (files/modules)</field>
          <field>Constraints from Current Code</field>
        </fields>
      </output_required>
      <rule>No code in this phase.</rule>
    </phase2_existing_architecture_alignment>

    <phase3_logic_flow_design>
      <goal>Design the feature logic as an implementable flow.</goal>
      <actions>
        <action>Describe the end-to-end flow step-by-step (inputs -> processing -> outputs).</action>
        <action>Define key states and transitions (state machine thinking if needed).</action>
        <action>Define rules and validations (what is allowed/blocked and why).</action>
        <action>Define error cases and handling behavior consistent with existing code.</action>
        <action>Define permissions/roles rules if applicable.</action>
      </actions>
      <output_required>
        <section_name>Logic Flow</section_name>
        <fields>
          <field>Inputs</field>
          <field>Flow Steps</field>
          <field>States / Transitions</field>
          <field>Rules / Validation</field>
          <field>Error Handling</field>
          <field>Permissions (if any)</field>
        </fields>
      </output_required>
      <rule>No UI design. No layout. No styling.</rule>
      <rule>No code in this phase.</rule>
    </phase3_logic_flow_design>

    <phase4_data_contracts_and_api>
      <goal>Define data shape and integration without deviating from project conventions.</goal>
      <actions>
        <action>Identify existing types/interfaces/DTOs to reuse.</action>
        <action>If new fields are required, propose additions consistent with naming/type style.</action>
        <action>Define API contract changes only if required; otherwise reuse existing endpoints/services.</action>
        <action>Define request/response mapping patterns consistent with existing code.</action>
      </actions>
      <output_required>
        <section_name>Data & Contracts</section_name>
        <fields>
          <field>Existing Types to Reuse</field>
          <field>New/Changed Fields (if needed)</field>
          <field>API/Service Calls (reuse first)</field>
          <field>Mapping / Validation Plan</field>
        </fields>
      </output_required>
      <rule>No code in this phase.</rule>
    </phase4_data_contracts_and_api>

    <phase5_edge_cases_and_risks>
      <goal>Make the design robust and realistic.</goal>
      <actions>
        <action>List edge cases (empty data, race conditions, retries, duplicates, offline, stale cache).</action>
        <action>List compatibility constraints (browser/device/version/config/flags).</action>
        <action>Identify risks and blast radius (what could break).</action>
        <action>Propose minimal safeguards consistent with current code patterns.</action>
      </actions>
      <output_required>
        <section_name>Edge Cases & Risks</section_name>
        <fields>
          <field>Edge Cases</field>
          <field>Risks / Blast Radius</field>
          <field>Safeguards / Fallbacks</field>
          <field>Feature Flag Plan (if applicable)</field>
        </fields>
      </output_required>
      <rule>No code in this phase.</rule>
    </phase5_edge_cases_and_risks>

    <phase6_implementation_plan>
      <goal>Translate the design into a concrete implementation plan.</goal>
      <actions>
        <action>List the minimal set of code changes by file/module.</action>
        <action>For each change: describe what to add/modify and what to reuse.</action>
        <action>Ensure naming and structure match existing conventions.</action>
        <action>Define test/verification plan (user-run + automated if available).</action>
      </actions>
      <output_required>
        <section_name>Implementation Plan</section_name>
        <fields>
          <field>Change List (by file/module)</field>
          <field>Reuse Plan</field>
          <field>Minimal Steps</field>
          <field>Verification Plan (user-run)</field>
          <field>Optional Tests (if project has tests)</field>
        </fields>
      </output_required>
      <rule>No code until user confirms the design.</rule>
    </phase6_implementation_plan>

    <phase7_user_visible_reasoning_template>
      <goal>Make the design thinking visible to the user.</goal>
      <required_output>
        <template>
          1) Feature Summary
          2) Architecture Fit
          3) Logic Flow
          4) Data & Contracts
          5) Edge Cases & Risks
          6) Implementation Plan
          7) Open Questions / Confirmation
        </template>
      </required_output>
      <rule>Always output these sections before proposing code.</rule>
    </phase7_user_visible_reasoning_template>

  </workflow>

  <hard_constraints>
    <constraint>Design must align with the existing codebase architecture and patterns.</constraint>
    <constraint>Use Breezell index/search to find similar features and reuse candidates.</constraint>
    <constraint>If context is insufficient, ask for the missing files or details. Do not guess.</constraint>
    <constraint>No UI design in this document.</constraint>
    <constraint>No code output until the user confirms the design.</constraint>
  </hard_constraints>

  <return_to_index>
    <instruction>
      After the design is confirmed,
      return to "00_context_index.xml" and continue the normal workflow.
    </instruction>
  </return_to_index>

</feature_logic_design_rules>
