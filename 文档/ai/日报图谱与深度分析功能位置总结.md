# 日报图谱与深度分析功能位置总结
## 1. 总览（你要找的“类/模块”）
当前“日报图谱 + 深度分析”能力，主链路分布在以下模块：
- 接口入口层：`src/jiekouxt/jiekou_nr/ribao/jiekou_ribao.rs`
- 业务编排层：`src/yewu/ribao_fenxi/fenxi_yongli.rs`
- 分析仓储适配层：`src/yewu/ribao_fenxi/cangchu.rs`
- AI分析执行层：`src/gongju/ai/openai/feiduihuagongju/kuaribaofenxi.rs`
- AI统一JSON执行器：`src/gongju/ai/openai/feiduihuagongju/ai_zhixingqi.rs`
- 关系提取分析层（人/公司关系边）：`src/gongju/ai/openai/feiduihuagongju/guanxifenxi.rs`
- 图谱/标签数据存储层：`src/shujuku/psqlshujuku/shujubiao_nr/ribao/shujucaozuo_ribao_biaoqian.rs`
- 关系边数据存储层：`src/shujuku/psqlshujuku/shujubiao_nr/ribao/shujucaozuo_ribao_guanxi.rs`
- AI配置与分析维度配置：`src/peizhixt/peizhi_nr/peizhi_ai.rs`
- 提示词与JSON格式契约：`src/peizhixt/peizhi_nr/tishici_moban.rs`

## 2. 图谱功能在哪些模块
### 2.1 接口层（对外操作名）
文件：`src/jiekouxt/jiekou_nr/ribao/jiekou_ribao.rs`
关键操作：
- `tupu_quanbu`
- `tupu_biaoqianid`
- `tupu_leixingmingcheng`
- `tupu_sousuo`
- `tupu_ribao_fenye`
- `tupu_bian_ribao_fenye`
- `tupu_guanxi_shiti_ribao_fenye`
- `tupu_guanxi_bian_ribao_fenye`
- `tupu_ribao_duobiaoqian_fenye`

这些操作统一在 `chulicaozuo` 分支里分发，属于管理员接口 `/jiekou/ribao/guanli`。

### 2.2 数据/图谱构建层
文件：`src/shujuku/psqlshujuku/shujubiao_nr/ribao/shujucaozuo_ribao_biaoqian.rs`
核心函数：
- 图谱主体查询：
  - `chaxun_tupu_quanbu`
  - `chaxun_tupu_biaoqianid`
  - `chaxun_tupu_leixingmingcheng`
- 图谱辅助查询：
  - `tupu_sousuo`
  - `tupu_ribao_fenye`
  - `tupu_bian_ribao_fenye`
  - `tupu_ribao_duobiaoqian_fenye`
- 图谱聚合基础：
  - `chaxun_tupu_jiedian`（节点）
  - `chaxun_tupu_bian` / `chaxun_tupu_bian_anzifanwei`（共现边）
  - `juhe_biaoqian_zhi_anleixing`（按类型聚合实体）
  - `juhe_jiaoliuneirong_anshiti`（按实体聚合交流内容）
  - `juhe_shiti_biaoqian`（按实体聚合标签）

### 2.3 关系边（AI关系）落库与图谱扩展
文件：`src/shujuku/psqlshujuku/shujubiao_nr/ribao/shujucaozuo_ribao_guanxi.rs`
核心函数：
- 写入/更新：
  - `xinzeng`
  - `gengxin_ribao_guanxi`（先清后写）
- 图谱聚合关系边：
  - `chaxun_juhe_quanbu`
  - `chaxun_juhe_an_biaoqianid`
  - `chaxun_juhe_an_leixingmingcheng`
  - `chaxun_juhe_guanxi`
- 关系边回溯日报：
  - `chaxun_ribao_an_shitimingcheng`
  - `chaxun_ribao_an_guanxidui`

## 3. 深度分析功能在哪些模块
### 3.1 接口层（深度分析入口）
文件：`src/jiekouxt/jiekou_nr/ribao/jiekou_ribao.rs`
关键操作：
- `fenxi_jiaoliu_neirong`（交流分析）
- `fenxi_ai_shendu`（单实体按维度深度分析）
- `fenxi_shiti_guanlian`（同类型多实体关联分析）
- `fenxi_zonghe_guanlian`（跨类型综合关联分析）
- `fenxi_xiangmu_guanlian`（项目关联分析兼容入口）
- `fenxi_shiti_ribao` / `fenxi_chaxun_jiaoliu` / `fenxi_shiti_liebiao`（分析前置数据）
- `fenxi_huoqu_shiti_leixing`（分析面板类型配置）

### 3.2 业务编排层（分析核心“用例”）
文件：`src/yewu/ribao_fenxi/fenxi_yongli.rs`
核心函数：
- `jiaoliu_neirong_fenxi`
- `shendu_fenxi`
- `shiti_guanlian_fenxi`
- `zonghe_guanlian_fenxi`

职责：
- 调仓储层拿实体关联日报/标签/交流内容
- 拼接AI输入（包括多篇日报原文）
- 调 AI 分析函数
- 标准化返回 `ai_fenxi` 结果结构

### 3.3 仓储适配层（业务与数据库解耦）
文件：`src/yewu/ribao_fenxi/cangchu.rs`
关键函数：
- `chaxun_jiaoliu_neirong`
- `chaxun_shiti_biaoqian`
- `chaxun_shiti_ribao`

职责：
- 把底层 `Value` 查询结果转成强类型结构
- 统一仓储错误语义（查询失败/结果为空）

### 3.4 AI分析执行层
文件：`src/gongju/ai/openai/feiduihuagongju/kuaribaofenxi.rs`
关键函数：
- `ai_jiaoliu_fenxi`
- `ai_ribao_shendu_fenxi`
- `ai_xiangmu_guanlian_fenxi`
- `ai_guanlian_shendu_fenxi`

文件：`src/gongju/ai/openai/feiduihuagongju/ai_zhixingqi.rs`
关键函数：
- `zhixing_ai_json`
- `zhixing_ai_json_jianbian`

职责：
- 统一执行“提示词 -> 调模型 -> 清洗JSON -> 校验JSON”的流程

### 3.5 关系分析（人物/公司关系抽取）
文件：`src/gongju/ai/openai/feiduihuagongju/guanxifenxi.rs`
关键函数：
- `ai_shengcheng_guanxifenxi`
- `tiqu_guanxilie`
- `hebing_guanxilie`

职责：
- 从日报中抽取关系对
- 长文本分段分析
- 关系去重聚合（方向统一、证据合并、负面情感优先）

## 4. 前端展示对应位置
### 4.1 分析页面
- 主页面控制与事件：`wasm_sdk/ribao_jiemian.js`
  - `shuaxinfenxishitu`
  - `fenxi_jiaoliu`
  - `fenxi_kaishi_fenxi`
  - `fenxi_shiti_guanlian`
  - `fenxi_zonghe_guanlian`
  - `fenxi_guanlian_kaishi`
- API适配：`wasm_sdk/ribao_luoji.js`（`FenxiApiClient`）
- 分析状态：`wasm_sdk/fenxi_zhuangtai.js`（`FenxiZhuangtai`）
- 分析渲染：`wasm_sdk/fenxi_xuanran.js`

### 4.2 图谱页面
- 页面控制与侧栏交互：`wasm_sdk/ribao_jiemian.js`
  - `shuaxintupushitu`
  - `_tupu_jiazai_impl`
  - `_tupu_xuanran`
  - `_tupu_xianshi_celan_jiedian` / `_tupu_xianshi_celan_bian` / `_tupu_xianshi_celan_guanxibian`
- 图谱引擎渲染：`wasm_sdk/tupu_xuanran.js`（`TupuXuanran`）
- 后端调用封装：`wasm_sdk/ribao_luoji.js`
  - `tupu_chaxun_quanbu`
  - `tupu_chaxun_biaoqianid`
  - `tupu_chaxun_leixingmingcheng`
  - `tupu_sousuo`
  - `tupu_*_ribao_fenye`

## 5. 配置与提示词位置
### 5.1 AI配置结构
文件：`src/peizhixt/peizhi_nr/peizhi_ai.rs`
关键字段：
- `fenxi_shiti_leixing`
- `guanxifenxi_leixing`
- `jiaoliu_fenxi_tishici`
- `shendu_fenxi_tishici`
- `xiangmu_guanlian_tishici`
- `guanlian_shendu_tishici`

### 5.2 提示词模板与JSON契约
文件：`src/peizhixt/peizhi_nr/tishici_moban.rs`
关键内容：
- `shendu_fenxi_json_geshi`（深度分析输出格式）
- `guanlian_shendu_json_geshi`（关联深度分析输出格式）
- `jiaoliu_fenxi` / `shendu_fenxi` / `xiangmu_guanlian` / `guanlian_shendu_fenxi`

## 6. 当前暴露状态（重要）
- “图谱/分析”接口目前走 `jiekou_ribao.rs` 的管理员入口（`/jiekou/ribao/guanli`）。
- 普通用户接口 `jiekou_ribao_yonghu.rs` 当前不包含上述 `tupu_*` / `fenxi_*` 操作分发。
- 对话工具注册（`gongjuji/mod.rs`）当前主要是 `xunwen`、`ribao_jiancha`、`ribao_renwubiaoqian_chuli` 等，图谱/深度分析能力主要在非对话业务链路中调用。

## 7. 你下一步可改造的优先位置
### 7.1 若要扩展“分析维度”
优先改：
- `src/peizhixt/peizhi_nr/peizhi_ai.rs`（`fenxi_shiti_leixing`、提示词字段）
- `src/peizhixt/peizhi_nr/tishici_moban.rs`（默认提示词与输出契约）
- `wasm_sdk/fenxi_xuanran.js`（新字段渲染）

### 7.2 若要扩展“图谱节点/边类型”
优先改：
- `src/shujuku/psqlshujuku/shujubiao_nr/ribao/shujucaozuo_ribao_biaoqian.rs`
- `src/shujuku/psqlshujuku/shujubiao_nr/ribao/shujucaozuo_ribao_guanxi.rs`
- `wasm_sdk/tupu_xuanran.js`（颜色、图例、交互）

### 7.3 若要把分析能力接入对话工具流
优先改：
- `src/gongju/ai/openai/gongjuji/mod.rs`（工具注册）
- 对应新增 `gongjuji/*` 工具模块（包装现有 `fenxi_yongli`/`kuaribaofenxi` 调用）
- `src/jiekouxt/jiekou_nr/ai/mod.rs`（对话流程调度策略）

